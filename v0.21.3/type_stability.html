<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Importance of Type-Stability | QuantumToolbox.jl</title>
    <meta name="description" content="Documentation for QuantumToolbox.jl">
    <meta name="generator" content="VitePress v1.5.0">
    <link rel="preload stylesheet" href="/QuantumToolbox.jl/v0.21.3/assets/style.R1LYH8Xi.css" as="style">
    <link rel="preload stylesheet" href="/QuantumToolbox.jl/v0.21.3/vp-icons.css" as="style">
    
    <script type="module" src="/QuantumToolbox.jl/v0.21.3/assets/app.EzQ6epHj.js"></script>
    <link rel="preload" href="/QuantumToolbox.jl/v0.21.3/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/QuantumToolbox.jl/v0.21.3/assets/chunks/theme.Cs2YruoC.js">
    <link rel="modulepreload" href="/QuantumToolbox.jl/v0.21.3/assets/chunks/framework.B45H23c5.js">
    <link rel="modulepreload" href="/QuantumToolbox.jl/v0.21.3/assets/type_stability.md.DYoCA6vB.lean.js">
    <link rel="icon" href="/favicon.ico">
    <script src="/QuantumToolbox.jl/versions.js"></script>
    <script src="/QuantumToolbox.jl/v0.21.3/siteinfo.js"></script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-a9a9e638><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c3508ec8></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c3508ec8> Skip to content </a><!--]--><!----><header class="VPNav" data-v-a9a9e638 data-v-f1e365da><div class="VPNavBar" data-v-f1e365da data-v-822684d1><div class="wrapper" data-v-822684d1><div class="container" data-v-822684d1><div class="title" data-v-822684d1><div class="VPNavBarTitle has-sidebar" data-v-822684d1 data-v-0f4f798b><a class="title" href="/QuantumToolbox.jl/v0.21.3/" data-v-0f4f798b><!--[--><!--]--><!--[--><img class="VPImage logo" src="/QuantumToolbox.jl/v0.21.3/logo.png" width="24" height="24" alt data-v-35a7d0b8><!--]--><span data-v-0f4f798b>QuantumToolbox.jl</span><!--[--><!--]--></a></div></div><div class="content" data-v-822684d1><div class="content-body" data-v-822684d1><!--[--><!--]--><div class="VPNavBarSearch search" data-v-822684d1><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-822684d1 data-v-e6d46098><span id="main-nav-aria-label" class="visually-hidden" data-v-e6d46098> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/QuantumToolbox.jl/v0.21.3/index" tabindex="0" data-v-e6d46098 data-v-956ec74c><!--[--><span data-v-956ec74c>Home</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-e6d46098 data-v-04f5c5e9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-04f5c5e9><span class="text" data-v-04f5c5e9><!----><span data-v-04f5c5e9>Getting Started</span><span class="vpi-chevron-down text-icon" data-v-04f5c5e9></span></span></button><div class="menu" data-v-04f5c5e9><div class="VPMenu" data-v-04f5c5e9 data-v-7dd3104a><div class="items" data-v-7dd3104a><!--[--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/getting_started" data-v-acbfed09><!--[--><span data-v-acbfed09>Brief Example</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/qutip_differences" data-v-acbfed09><!--[--><span data-v-acbfed09>Key differences from QuTiP</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link active" href="/QuantumToolbox.jl/v0.21.3/type_stability" data-v-acbfed09><!--[--><span data-v-acbfed09>The Importance of Type-Stability</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-e6d46098 data-v-04f5c5e9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-04f5c5e9><span class="text" data-v-04f5c5e9><!----><span data-v-04f5c5e9>Users Guide</span><span class="vpi-chevron-down text-icon" data-v-04f5c5e9></span></span></button><div class="menu" data-v-04f5c5e9><div class="VPMenu" data-v-04f5c5e9 data-v-7dd3104a><div class="items" data-v-7dd3104a><!--[--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Basic Operations on Quantum Objects</p><!--[--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/QuantumObject/QuantumObject" data-v-acbfed09><!--[--><span data-v-acbfed09>Quantum Objects (Qobj)</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/QuantumObject/QuantumObject_functions" data-v-acbfed09><!--[--><span data-v-acbfed09>Functions operating on Qobj</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/states_and_operators" data-v-acbfed09><!--[--><span data-v-acbfed09>Manipulating States and Operators</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/tensor" data-v-acbfed09><!--[--><span data-v-acbfed09>Tensor Products and Partial Traces</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Time Evolution and Dynamics</p><!--[--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/intro" data-v-acbfed09><!--[--><span data-v-acbfed09>Introduction</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/solution" data-v-acbfed09><!--[--><span data-v-acbfed09>Time Evolution Solutions</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/sesolve" data-v-acbfed09><!--[--><span data-v-acbfed09>Schr√∂dinger Equation Solver</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/mesolve" data-v-acbfed09><!--[--><span data-v-acbfed09>Lindblad Master Equation Solver</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/mcsolve" data-v-acbfed09><!--[--><span data-v-acbfed09>Monte-Carlo Solver</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/stochastic" data-v-acbfed09><!--[--><span data-v-acbfed09>Stochastic Solver</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/time_dependent" data-v-acbfed09><!--[--><span data-v-acbfed09>Solving Problems with Time-dependent Hamiltonians</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/steadystate" data-v-acbfed09><!--[--><span data-v-acbfed09>Solving for Steady-State Solutions</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Symmetries</p><!--[--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Two-time correlation functions</p><!--[--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Extensions</p><!--[--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/users_guide/extensions/cuda" data-v-acbfed09><!--[--><span data-v-acbfed09>Extension for CUDA.jl</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-e6d46098 data-v-04f5c5e9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-04f5c5e9><span class="text" data-v-04f5c5e9><!----><span data-v-04f5c5e9>Tutorials</span><span class="vpi-chevron-down text-icon" data-v-04f5c5e9></span></span></button><div class="menu" data-v-04f5c5e9><div class="VPMenu" data-v-04f5c5e9 data-v-7dd3104a><div class="items" data-v-7dd3104a><!--[--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Time Evolution</p><!--[--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/tutorials/lowrank" data-v-acbfed09><!--[--><span data-v-acbfed09>Low Rank Master Equation</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-7dd3104a data-v-48c802d0><p class="title" data-v-48c802d0>Miscellaneous Tutorials</p><!--[--><!--[--><div class="VPMenuLink" data-v-48c802d0 data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/tutorials/logo" data-v-acbfed09><!--[--><span data-v-acbfed09>Create QuantumToolbox.jl logo</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-e6d46098 data-v-04f5c5e9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-04f5c5e9><span class="text" data-v-04f5c5e9><!----><span data-v-04f5c5e9>Resources</span><span class="vpi-chevron-down text-icon" data-v-04f5c5e9></span></span></button><div class="menu" data-v-04f5c5e9><div class="VPMenu" data-v-04f5c5e9 data-v-7dd3104a><div class="items" data-v-7dd3104a><!--[--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/resources/api" data-v-acbfed09><!--[--><span data-v-acbfed09>API</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-7dd3104a data-v-acbfed09><a class="VPLink link" href="/QuantumToolbox.jl/v0.21.3/resources/bibliography" data-v-acbfed09><!--[--><span data-v-acbfed09>Bibliography</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://qutip.org/QuantumToolbox.jl/benchmarks/" target="_blank" rel="noreferrer" tabindex="0" data-v-e6d46098 data-v-956ec74c><!--[--><span data-v-956ec74c>Benchmarks</span><!--]--></a><!--]--><!--[--><!----><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-822684d1 data-v-af096f4a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-af096f4a data-v-e40a8bb6 data-v-4a1c76db><span class="check" data-v-4a1c76db><span class="icon" data-v-4a1c76db><!--[--><span class="vpi-sun sun" data-v-e40a8bb6></span><span class="vpi-moon moon" data-v-e40a8bb6></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-822684d1 data-v-164c457f data-v-ee7a9424><!--[--><a class="VPSocialLink no-icon" href="https://github.com/qutip/QuantumToolbox.jl" aria-label="github" target="_blank" rel="noopener" data-v-ee7a9424 data-v-d26d30cb><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-822684d1 data-v-925effce data-v-04f5c5e9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-04f5c5e9><span class="vpi-more-horizontal icon" data-v-04f5c5e9></span></button><div class="menu" data-v-04f5c5e9><div class="VPMenu" data-v-04f5c5e9 data-v-7dd3104a><!----><!--[--><!--[--><!----><div class="group" data-v-925effce><div class="item appearance" data-v-925effce><p class="label" data-v-925effce>Appearance</p><div class="appearance-action" data-v-925effce><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-925effce data-v-e40a8bb6 data-v-4a1c76db><span class="check" data-v-4a1c76db><span class="icon" data-v-4a1c76db><!--[--><span class="vpi-sun sun" data-v-e40a8bb6></span><span class="vpi-moon moon" data-v-e40a8bb6></span><!--]--></span></span></button></div></div></div><div class="group" data-v-925effce><div class="item social-links" data-v-925effce><div class="VPSocialLinks social-links-list" data-v-925effce data-v-ee7a9424><!--[--><a class="VPSocialLink no-icon" href="https://github.com/qutip/QuantumToolbox.jl" aria-label="github" target="_blank" rel="noopener" data-v-ee7a9424 data-v-d26d30cb><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-822684d1 data-v-5dea55bf><span class="container" data-v-5dea55bf><span class="top" data-v-5dea55bf></span><span class="middle" data-v-5dea55bf></span><span class="bottom" data-v-5dea55bf></span></span></button></div></div></div></div><div class="divider" data-v-822684d1><div class="divider-line" data-v-822684d1></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-a9a9e638 data-v-070ab83d><div class="container" data-v-070ab83d><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-070ab83d><span class="vpi-align-left menu-icon" data-v-070ab83d></span><span class="menu-text" data-v-070ab83d>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-070ab83d data-v-bc9dc845><button data-v-bc9dc845>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-a9a9e638 data-v-18756405><div class="curtain" data-v-18756405></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-18756405><span class="visually-hidden" id="sidebar-aria-label" data-v-18756405> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-196b2e5f><!----><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/index" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Home</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0 collapsible has-active" data-v-9e426adc data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h2 class="text" data-v-196b2e5f>Getting Started</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/getting_started" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Brief Example</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/qutip_differences" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Key differences from QuTiP</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/type_stability" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>The Importance of Type-Stability</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0 collapsible" data-v-9e426adc data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h2 class="text" data-v-196b2e5f>Users Guide</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><section class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h3 class="text" data-v-196b2e5f>Basic Operations on Quantum Objects</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/QuantumObject/QuantumObject" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Quantum Objects (Qobj)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/QuantumObject/QuantumObject_functions" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Functions operating on Qobj</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/states_and_operators" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Manipulating States and Operators</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/tensor" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Tensor Products and Partial Traces</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h3 class="text" data-v-196b2e5f>Time Evolution and Dynamics</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/intro" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Introduction</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/solution" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Time Evolution Solutions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/sesolve" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Schr√∂dinger Equation Solver</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/mesolve" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Lindblad Master Equation Solver</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/mcsolve" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Monte-Carlo Solver</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/stochastic" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Stochastic Solver</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/time_evolution/time_dependent" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Solving Problems with Time-dependent Hamiltonians</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/steadystate" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Solving for Steady-State Solutions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><p class="text" data-v-196b2e5f>Symmetries</p><!----></div><!----></div><div class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><p class="text" data-v-196b2e5f>Two-time correlation functions</p><!----></div><!----></div><section class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h3 class="text" data-v-196b2e5f>Extensions</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/users_guide/extensions/cuda" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Extension for CUDA.jl</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0 collapsible" data-v-9e426adc data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h2 class="text" data-v-196b2e5f>Tutorials</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><section class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h3 class="text" data-v-196b2e5f>Time Evolution</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/tutorials/lowrank" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Low Rank Master Equation</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-196b2e5f data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h3 class="text" data-v-196b2e5f>Miscellaneous Tutorials</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-2 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/tutorials/logo" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Create QuantumToolbox.jl logo</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0 collapsible" data-v-9e426adc data-v-196b2e5f><div class="item" role="button" tabindex="0" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><h2 class="text" data-v-196b2e5f>Resources</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-196b2e5f><span class="vpi-chevron-right caret-icon" data-v-196b2e5f></span></div></div><div class="items" data-v-196b2e5f><!--[--><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/resources/api" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>API</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-196b2e5f data-v-196b2e5f><div class="item" data-v-196b2e5f><div class="indicator" data-v-196b2e5f></div><a class="VPLink link link" href="/QuantumToolbox.jl/v0.21.3/resources/bibliography" data-v-196b2e5f><!--[--><p class="text" data-v-196b2e5f>Bibliography</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-a9a9e638 data-v-91765379><div class="VPDoc has-sidebar has-aside" data-v-91765379 data-v-83890dd9><!--[--><!--]--><div class="container" data-v-83890dd9><div class="aside" data-v-83890dd9><div class="aside-curtain" data-v-83890dd9></div><div class="aside-container" data-v-83890dd9><div class="aside-content" data-v-83890dd9><div class="VPDocAside" data-v-83890dd9 data-v-6d7b3c46><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-6d7b3c46 data-v-b38bf2ff><div class="content" data-v-b38bf2ff><div class="outline-marker" data-v-b38bf2ff></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-b38bf2ff>On this page</div><ul class="VPDocOutlineItem root" data-v-b38bf2ff data-v-3f927ebe><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-6d7b3c46></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-83890dd9><div class="content-container" data-v-83890dd9><!--[--><!--]--><main class="main" data-v-83890dd9><div style="position:relative;" class="vp-doc _QuantumToolbox_jl_v0_21_3_type_stability" data-v-83890dd9><div><h1 id="doc:Type-Stability" tabindex="-1">The Importance of Type-Stability <a class="header-anchor" href="#doc:Type-Stability" aria-label="Permalink to &quot;The Importance of Type-Stability {#doc:Type-Stability}&quot;">‚Äã</a></h1><p>You are here because you have probably heard about the excellent performance of Julia compared to other common programming languages like Python. One of the reasons is the Just-In-Time (JIT) compiler of Julia, which is able to generate highly optimized machine code. However, the JIT compiler can only do its job if the code type can be inferred. You can also read the <a href="https://docs.julialang.org/en/v1/manual/performance-tips/" target="_blank" rel="noreferrer">Performance Tips</a> section in Julia&#39;s documentation for more details. Here, we try to explain it briefly, with a focus on the <code>QuantumToolbox.jl</code> package.</p><div class="tip custom-block"><p class="custom-block-title">Note</p><p>This page is not a tutorial on <code>QuantumToolbox.jl</code>, but rather a general guide to writing Julia code for simulating quantum systems efficiently. If you don&#39;t care about the performance of your code, you can skip this page.</p></div><h2 id="Basics-of-type-stability" tabindex="-1">Basics of type stability <a class="header-anchor" href="#Basics-of-type-stability" aria-label="Permalink to &quot;Basics of type stability {#Basics-of-type-stability}&quot;">‚Äã</a></h2><p>Let&#39;s have a look at the following example:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The function <code>foo</code> apparently seems to be innocent. It takes an argument <code>x</code> and returns either <code>1</code> or <code>-1.0</code> depending on the sign of <code>x</code>. However, the return type of <code>foo</code> is not clear. If <code>x</code> is positive, the return type is <code>Int</code>, otherwise it is <code>Float64</code>. This is a problem for the JIT compiler, because it has to determine the return type of <code>foo</code> at runtime. This is called type instability (even though it is a weak form) and may lead to a significant performance penalty. To avoid this, always aim for type-stable code. This means that the return type of a function should be clear from the types of its arguments. We can check the inferred return type of <code>foo</code> using the <code>@code_warntype</code> macro:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Main.var&quot;Main&quot;.foo(::Int64)</span></span>
<span class="line"><span>  from foo(x) @ Main.var&quot;Main&quot; type_stability.md:18</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #self#::Core.Const(Main.var&quot;Main&quot;.foo)</span></span>
<span class="line"><span>  x::Int64</span></span>
<span class="line"><span>Body::UNION{FLOAT64, INT64}</span></span>
<span class="line"><span>1 ‚îÄ %1 = Main.var&quot;Main&quot;.:&gt;::Core.Const(&gt;)</span></span>
<span class="line"><span>‚îÇ   %2 = (%1)(x, 0)::Bool</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ      goto #3 if not %2</span></span>
<span class="line"><span>2 ‚îÄ      return 1</span></span>
<span class="line"><span>3 ‚îÄ      return -1.0</span></span></code></pre></div><p>The key point is to ensure the return type of a function is clear from the types of its arguments. There are several ways to achieve this, and the best approach depends on the specific problem. For example, one can use the same return type:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>Or you can ensure the return type matches the type of the argument:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The latter example is very important because it takes advantage of Julia&#39;s multiple dispatch, which is one of the most powerful features of the language. Depending on the type <code>T</code> of the argument <code>x</code>, the Julia compiler generates a specialized version of <code>foo</code> that is optimized for this type. If the input type is an <code>Int64</code>, the return type is <code>Int64</code>, if <code>x</code> is a <code>Float64</code>, the return type is <code>Float64</code>, and so on.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">//</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>foo(1) = 1</span></span>
<span class="line"><span>foo(-4.4) = -1.0</span></span>
<span class="line"><span>foo(1 // 2) = 1//1</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">Note</p><p>If you didn&#39;t know how to make this function type-stable, it is probably a good idea to read the official Julia documentation, and in particular its <a href="https://docs.julialang.org/en/v1/manual/performance-tips/" target="_blank" rel="noreferrer">Performance Tips</a> section.</p></div><h2 id="Global-variables" tabindex="-1">Global variables <a class="header-anchor" href="#Global-variables" aria-label="Permalink to &quot;Global variables {#Global-variables}&quot;">‚Äã</a></h2><p>Another source of type instability is the use of global variables. In general, it is a good idea to declare global variables as <code>const</code> to ensure their type is fixed for the entire program. For example, consider the following function that internally takes a global variable <code>y</code>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zero</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this returns the zero of the same type of x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The Julia compiler cannot infer the type of <code>res</code> because it depends on the type of <code>y</code>, which is a global variable that can change at any time of the program. We can check it using the <code>@code_warntype</code> macro:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Main.var&quot;Main&quot;.bar(::Float64)</span></span>
<span class="line"><span>  from bar(x) @ Main.var&quot;Main&quot; type_stability.md:79</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #self#::Core.Const(Main.var&quot;Main&quot;.bar)</span></span>
<span class="line"><span>  x::Float64</span></span>
<span class="line"><span>Locals</span></span>
<span class="line"><span>  @_3::UNION{NOTHING, TUPLE{INT64, INT64}}</span></span>
<span class="line"><span>  res::ANY</span></span>
<span class="line"><span>  i::Int64</span></span>
<span class="line"><span>Body::ANY</span></span>
<span class="line"><span>1 ‚îÄ %1  = Main.var&quot;Main&quot;.zero::Core.Const(zero)</span></span>
<span class="line"><span>‚îÇ         (res = (%1)(x))</span></span>
<span class="line"><span>‚îÇ   %3  = Main.var&quot;Main&quot;.:(:)::Core.Const(Colon())</span></span>
<span class="line"><span>‚îÇ   %4  = (%3)(1, 1000)::Core.Const(1:1000)</span></span>
<span class="line"><span>‚îÇ         (@_3 = Base.iterate(%4))</span></span>
<span class="line"><span>‚îÇ   %6  = @_3::Core.Const((1, 1))</span></span>
<span class="line"><span>‚îÇ   %7  = (%6 === nothing)::Core.Const(false)</span></span>
<span class="line"><span>‚îÇ   %8  = Base.not_int(%7)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ       goto #4 if not %8</span></span>
<span class="line"><span>2 ‚îÑ %10 = @_3::Tuple{Int64, Int64}</span></span>
<span class="line"><span>‚îÇ         (i = Core.getfield(%10, 1))</span></span>
<span class="line"><span>‚îÇ   %12 = Core.getfield(%10, 2)::Int64</span></span>
<span class="line"><span>‚îÇ   %13 = Main.var&quot;Main&quot;.:+::Core.Const(+)</span></span>
<span class="line"><span>‚îÇ   %14 = res::ANY</span></span>
<span class="line"><span>‚îÇ   %15 = Main.var&quot;Main&quot;.:*::Core.Const(*)</span></span>
<span class="line"><span>‚îÇ   %16 = (%15)(Main.var&quot;Main&quot;.y, x)::ANY</span></span>
<span class="line"><span>‚îÇ         (res = (%13)(%14, %16))</span></span>
<span class="line"><span>‚îÇ         (@_3 = Base.iterate(%4, %12))</span></span>
<span class="line"><span>‚îÇ   %19 = @_3::UNION{NOTHING, TUPLE{INT64, INT64}}</span></span>
<span class="line"><span>‚îÇ   %20 = (%19 === nothing)::Bool</span></span>
<span class="line"><span>‚îÇ   %21 = Base.not_int(%20)::Bool</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ       goto #4 if not %21</span></span>
<span class="line"><span>3 ‚îÄ       goto #2</span></span>
<span class="line"><span>4 ‚îÑ %24 = res::ANY</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ       return %24</span></span></code></pre></div><p>While in the last example of the <code>foo</code> function we got a weak form of type instability, returning a <code>Union{Int, Float64}</code>, in this case the return type of <code>bar</code> is <code>Any</code>, meaning that the compiler doesn&#39;t know anything about the return type. Thus, this function has nothing different from a dynamically typed language like Python. We can benchmark the performance of <code>bar</code> using the <a href="https://github.com/JuliaCI/BenchmarkTools.jl" target="_blank" rel="noreferrer">BenchmarkTools.jl</a> package:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BenchmarkTools</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>BenchmarkTools.Trial: 10000 samples with 1 evaluation.</span></span>
<span class="line"><span> Range (min ‚Ä¶ max):  42.960 Œºs ‚Ä¶  55.886 ms  ‚îä GC (min ‚Ä¶ max): 0.00% ‚Ä¶ 99.83%</span></span>
<span class="line"><span> Time  (median):     63.129 Œºs               ‚îä GC (median):    0.00%</span></span>
<span class="line"><span> Time  (mean ¬± œÉ):   65.971 Œºs ¬± 558.309 Œºs  ‚îä GC (mean ¬± œÉ):  8.46% ¬±  1.00%</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ‚ñÉ‚ñÉ‚ñÉ‚ñÖ‚ñá‚ñÖ‚ñÅ‚ñÅ‚ñÇ                     ‚ñÇ‚ñÉ‚ñÉ‚ñÜ‚ñá‚ñÜ‚ñá‚ñà‚ñá‚ñá‚ñÜ‚ñÖ‚ñÉ‚ñÇ‚ñÅ‚ñÅ‚ñÅ  ‚ñÅ‚ñÅ‚ñÅ‚ñÇ‚ñÇ‚ñÅ    ‚ñÉ</span></span>
<span class="line"><span>  ‚ñá‚ñá‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÜ‚ñÖ‚ñÅ‚ñÖ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÉ‚ñÅ‚ñÖ‚ñÉ‚ñÖ‚ñÑ‚ñÑ‚ñÅ‚ñÉ‚ñÉ‚ñÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñá‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà</span></span>
<span class="line"><span>  43 Œºs         Histogram: log(frequency) by time      74.1 Œºs &lt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> Memory estimate: 46.88 KiB, allocs estimate: 3000.</span></span></code></pre></div><p>Here we see a lot of memory allocations and low performances in general. To fix this, we can declare a <code>const</code> (constant) variable instead:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zero</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this returns the zero of the same type of x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>BenchmarkTools.Trial: 10000 samples with 57 evaluations.</span></span>
<span class="line"><span> Range (min ‚Ä¶ max):  868.807 ns ‚Ä¶  1.282 Œºs  ‚îä GC (min ‚Ä¶ max): 0.00% ‚Ä¶ 0.00%</span></span>
<span class="line"><span> Time  (median):     869.702 ns              ‚îä GC (median):    0.00%</span></span>
<span class="line"><span> Time  (mean ¬± œÉ):   871.749 ns ¬± 17.298 ns  ‚îä GC (mean ¬± œÉ):  0.00% ¬± 0.00%</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  ‚ñà                                                             </span></span>
<span class="line"><span>  ‚ñà‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÇ‚ñÇ‚ñÇ‚ñÇ ‚ñÇ</span></span>
<span class="line"><span>  869 ns          Histogram: frequency by time          999 ns &lt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> Memory estimate: 0 bytes, allocs estimate: 0.</span></span></code></pre></div><p>And we can see that the performance has improved significantly. Hence, we highly recommend using global variables as <code>const</code>, but only when truly necessary. This choice is problem-dependent, but in the case of <code>QuantumToolbox.jl</code>, this can be applied for example in the case of defining the Hilbert space dimensions, static parameters, or the system operators.</p><p>Although it is always a good practice to avoid such kind of type instabilities, in the actual implementation of <code>QuantumToolbox.jl</code> (where we mainly deal with linear algebra operations), the compiler may perform only a few runtime dispatches, and the performance penalty may be negligible compared to the heavy linear algebra operations.</p><h2 id="Vectors-vs-Tuples-vs-StaticArrays" tabindex="-1">Vectors vs Tuples vs StaticArrays <a class="header-anchor" href="#Vectors-vs-Tuples-vs-StaticArrays" aria-label="Permalink to &quot;Vectors vs Tuples vs StaticArrays {#Vectors-vs-Tuples-vs-StaticArrays}&quot;">‚Äã</a></h2><p>Julia has many ways to represent arrays or lists of general objects. The most common are <code>Vector</code>s and <code>Tuple</code>s. The former is a dynamic array that can change its size at runtime, while the latter is a fixed-size array that is immutable, and where the type of each element is already known at compile time. For example:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vector of Int64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vector of ComplexF64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ciao&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vector of Any</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tuple of {Int64, Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tuple of {ComplexF64, ComplexF64}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ciao&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tuple of {Int64, String, Float64}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v1)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v2)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v3)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t1)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t2)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t3)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>typeof(v1) = Vector{Int64}</span></span>
<span class="line"><span>typeof(v2) = Vector{ComplexF64}</span></span>
<span class="line"><span>typeof(v3) = Vector{Any}</span></span>
<span class="line"><span>typeof(t1) = Tuple{Int64, Int64, Int64}</span></span>
<span class="line"><span>typeof(t2) = Tuple{ComplexF64, ComplexF64}</span></span>
<span class="line"><span>typeof(t3) = Tuple{Int64, String, Float64}</span></span></code></pre></div><p>Thus, we highly recommend using <code>Vector</code> only when we are sure that it contains elements of the same type, and only when we don&#39;t need to know its size at compile time. On the other hand, <code>Tuple</code>s are less flexible but more efficient in terms of performance. A third option is to use the <code>SVector</code> type from the <a href="https://github.com/JuliaArrays/StaticArrays.jl" target="_blank" rel="noreferrer">StaticArrays.jl</a> package. This is similar to <code>Vector</code>, where the elements should have the same type, but it is fixed-size and immutable. One may ask when it is necessary to know the array size at compile time. A practical example is the case of <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.ptrace"><code>ptrace</code></a>, where it internally reshapes the quantum state into a tensor whose dimensions depend on the number of subsystems. We will see this in more detail in the next section.</p><h2 id="the-quantumobject-internal-structure-the-quantumobject-internal-structure" tabindex="-1">The <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a> internal structure {#The-<a href="./@ref">QuantumObject</a>-internal-structure} <a class="header-anchor" href="#the-quantumobject-internal-structure-the-quantumobject-internal-structure" aria-label="Permalink to &quot;The [`QuantumObject`](/resources/api#QuantumToolbox.QuantumObject) internal structure {#The-[QuantumObject](@ref)-internal-structure}&quot;">‚Äã</a></h2><p>Before making a practical example, let&#39;s see the internal structure of the <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a> type. As an example, we consider the case of three qubits, and we study the internal structure of the <mjx-container class="MathJax" jax="SVG" style="direction:ltr;position:relative;"><svg style="overflow:visible;min-height:1px;min-width:1px;vertical-align:-0.332ex;" xmlns="http://www.w3.org/2000/svg" width="3.524ex" height="2.732ex" role="img" focusable="false" viewBox="0 -1060.7 1557.7 1207.4" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D70E" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z" style="stroke-width:3;"></path></g><g data-mml-node="mo" transform="translate(285.5,16) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z" style="stroke-width:3;"></path></g></g></g><g data-mml-node="TeXAtom" transform="translate(604,530.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z" style="stroke-width:3;"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" style="stroke-width:3;"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z" style="stroke-width:3;"></path></g></g><g data-mml-node="mi" transform="translate(604,-138.9) scale(0.707)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z" style="stroke-width:3;"></path></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline" style="top:0px;left:0px;clip:rect(1px, 1px, 1px, 1px);-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:absolute;padding:1px 0px 0px 0px;border:0px;display:block;width:auto;overflow:hidden;"><math xmlns="http://www.w3.org/1998/Math/MathML"><msubsup><mrow data-mjx-texclass="ORD"><mover><mi>œÉ</mi><mo stretchy="false">^</mo></mover></mrow><mi>x</mi><mrow data-mjx-texclass="ORD"><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msubsup></math></mjx-assistive-mml></mjx-container> operator:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">œÉx_2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tensor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qeye</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sigmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qeye</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Quantum Object:   type=Operator   dims=[2, 2, 2]   size=(8, 8)   ishermitian=true</span></span>
<span class="line"><span>8√ó8 SparseMatrixCSC{ComplexF64, Int64} with 8 stored entries:</span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ      1.0+0.0im  ‚Ä¶      ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span> 1.0+0.0im      ‚ãÖ          ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ      1.0+0.0im      ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ             ‚ãÖ      1.0+0.0im      ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ      ‚Ä¶      ‚ãÖ          ‚ãÖ      1.0+0.0im</span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ         1.0+0.0im      ‚ãÖ          ‚ãÖ</span></span></code></pre></div><p>and its type is</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">obj_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(œÉx_2)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>QuantumObject{SparseMatrixCSC{ComplexF64, Int64}, OperatorQuantumObject, 3}</span></span></code></pre></div><p>This is exactly what the Julia compiler sees: it is a <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a>, composed by a field of type <code>SparseMatrixCSC{ComplexF64, Int64}</code> (i.e., the 8x8 matrix containing the Pauli matrix, tensored with the identity matrices of the other two qubits). Then, we can also see that it is a <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.OperatorQuantumObject"><code>OperatorQuantumObject</code></a>, with <code>3</code> subsystems in total. Hence, just looking at the type of the object, the compiler has all the information it needs to generate a specialized version of the functions.</p><p>Let&#39;s see more in the details all the internal fields of the <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a> type:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fieldnames</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(obj_type)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>(:data, :type, :dims)</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">œÉx_2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>8√ó8 SparseMatrixCSC{ComplexF64, Int64} with 8 stored entries:</span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ      1.0+0.0im  ‚Ä¶      ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span> 1.0+0.0im      ‚ãÖ          ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ      1.0+0.0im      ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ             ‚ãÖ      1.0+0.0im      ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ      ‚Ä¶      ‚ãÖ          ‚ãÖ      1.0+0.0im</span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ             ‚ãÖ          ‚ãÖ          ‚ãÖ    </span></span>
<span class="line"><span>     ‚ãÖ          ‚ãÖ          ‚ãÖ         1.0+0.0im      ‚ãÖ          ‚ãÖ</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">œÉx_2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">type</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Operator</span></span></code></pre></div><p><a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.Operator"><code>Operator</code></a> is a synonym for <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.OperatorQuantumObject"><code>OperatorQuantumObject</code></a>.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">œÉx_2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dims</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>3-element SVector{3, Int64} with indices SOneTo(3):</span></span>
<span class="line"><span> 2</span></span>
<span class="line"><span> 2</span></span>
<span class="line"><span> 2</span></span></code></pre></div><p>The <code>dims</code> field contains the dimensions of the subsystems (in this case, three subsystems with dimension <code>2</code> each). We can see that the type of <code>dims</code> is <code>SVector</code> instead of <code>Vector</code>. As we mentioned before, this is very useful in functions like <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.ptrace"><code>ptrace</code></a>. Let&#39;s do a simple example of reshaping an operator internally generated from some <code>dims</code> input:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dims)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Qobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">randn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">prod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dims), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">prod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dims)), type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Operator, dims</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dims)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op_dims </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dims</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(op_data, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vcat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(op_dims, op_dims)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Array{Float64, 6}</span></span></code></pre></div><p>Which returns a tensor of size <code>2x2x2x2x2x2</code>. Let&#39;s check the <code>@code_warntype</code>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Main.var&quot;Main&quot;.reshape_operator_data(::Vector{Int64})</span></span>
<span class="line"><span>  from reshape_operator_data(dims) @ Main.var&quot;Main&quot; type_stability.md:186</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #self#::Core.Const(Main.var&quot;Main&quot;.reshape_operator_data)</span></span>
<span class="line"><span>  dims::Vector{Int64}</span></span>
<span class="line"><span>Locals</span></span>
<span class="line"><span>  op_data::Matrix{Float64}</span></span>
<span class="line"><span>  op_dims::SVECTOR{_A, INT64} WHERE _A</span></span>
<span class="line"><span>  op::QUANTUMOBJECT{MATRIX{FLOAT64}, OPERATORQUANTUMOBJECT}</span></span>
<span class="line"><span>Body::ANY</span></span>
<span class="line"><span>1 ‚îÄ %1  = Main.var&quot;Main&quot;.randn::Core.Const(randn)</span></span>
<span class="line"><span>‚îÇ   %2  = Main.var&quot;Main&quot;.prod::Core.Const(prod)</span></span>
<span class="line"><span>‚îÇ   %3  = (%2)(dims)::Int64</span></span>
<span class="line"><span>‚îÇ   %4  = Main.var&quot;Main&quot;.prod::Core.Const(prod)</span></span>
<span class="line"><span>‚îÇ   %5  = (%4)(dims)::Int64</span></span>
<span class="line"><span>‚îÇ   %6  = (%1)(%3, %5)::Matrix{Float64}</span></span>
<span class="line"><span>‚îÇ   %7  = (:type, :dims)::Core.Const((:type, :dims))</span></span>
<span class="line"><span>‚îÇ   %8  = Core.apply_type(Core.NamedTuple, %7)::Core.Const(NamedTuple{(:type, :dims)})</span></span>
<span class="line"><span>‚îÇ   %9  = Main.var&quot;Main&quot;.Operator::Core.Const(Operator)</span></span>
<span class="line"><span>‚îÇ   %10 = Core.tuple(%9, dims)::Tuple{OperatorQuantumObject, Vector{Int64}}</span></span>
<span class="line"><span>‚îÇ   %11 = (%8)(%10)::@NamedTuple{type::OperatorQuantumObject, dims::Vector{Int64}}</span></span>
<span class="line"><span>‚îÇ   %12 = Main.var&quot;Main&quot;.Qobj::Core.Const(QuantumToolbox.Qobj)</span></span>
<span class="line"><span>‚îÇ         (op = Core.kwcall(%11, %12, %6))</span></span>
<span class="line"><span>‚îÇ   %14 = op::QUANTUMOBJECT{MATRIX{FLOAT64}, OPERATORQUANTUMOBJECT}</span></span>
<span class="line"><span>‚îÇ         (op_dims = Base.getproperty(%14, :dims))</span></span>
<span class="line"><span>‚îÇ   %16 = op::QUANTUMOBJECT{MATRIX{FLOAT64}, OPERATORQUANTUMOBJECT}</span></span>
<span class="line"><span>‚îÇ         (op_data = Base.getproperty(%16, :data))</span></span>
<span class="line"><span>‚îÇ   %18 = Main.var&quot;Main&quot;.reshape::Core.Const(reshape)</span></span>
<span class="line"><span>‚îÇ   %19 = op_data::Matrix{Float64}</span></span>
<span class="line"><span>‚îÇ   %20 = Core.tuple(%19)::Tuple{Matrix{Float64}}</span></span>
<span class="line"><span>‚îÇ   %21 = Main.var&quot;Main&quot;.vcat::Core.Const(vcat)</span></span>
<span class="line"><span>‚îÇ   %22 = op_dims::SVECTOR{_A, INT64} WHERE _A</span></span>
<span class="line"><span>‚îÇ   %23 = op_dims::SVECTOR{_A, INT64} WHERE _A</span></span>
<span class="line"><span>‚îÇ   %24 = (%21)(%22, %23)::ANY</span></span>
<span class="line"><span>‚îÇ   %25 = Core._apply_iterate(Base.iterate, %18, %20, %24)::ANY</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ       return %25</span></span></code></pre></div><p>We got a <code>Any</code> type, because the compiler doesn&#39;t know the size of the <code>dims</code> vector. We can fix this by using a <code>Tuple</code> (or <code>SVector</code>):</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Array{Float64, 6}</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Main.var&quot;Main&quot;.reshape_operator_data(::Tuple{Int64, Int64, Int64})</span></span>
<span class="line"><span>  from reshape_operator_data(dims) @ Main.var&quot;Main&quot; type_stability.md:186</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #self#::Core.Const(Main.var&quot;Main&quot;.reshape_operator_data)</span></span>
<span class="line"><span>  dims::Tuple{Int64, Int64, Int64}</span></span>
<span class="line"><span>Locals</span></span>
<span class="line"><span>  op_data::Matrix{Float64}</span></span>
<span class="line"><span>  op_dims::SVector{3, Int64}</span></span>
<span class="line"><span>  op::QuantumObject{Matrix{Float64}, OperatorQuantumObject, 3}</span></span>
<span class="line"><span>Body::Array{Float64, 6}</span></span>
<span class="line"><span>1 ‚îÄ %1  = Main.var&quot;Main&quot;.randn::Core.Const(randn)</span></span>
<span class="line"><span>‚îÇ   %2  = Main.var&quot;Main&quot;.prod::Core.Const(prod)</span></span>
<span class="line"><span>‚îÇ   %3  = (%2)(dims)::Int64</span></span>
<span class="line"><span>‚îÇ   %4  = Main.var&quot;Main&quot;.prod::Core.Const(prod)</span></span>
<span class="line"><span>‚îÇ   %5  = (%4)(dims)::Int64</span></span>
<span class="line"><span>‚îÇ   %6  = (%1)(%3, %5)::Matrix{Float64}</span></span>
<span class="line"><span>‚îÇ   %7  = (:type, :dims)::Core.Const((:type, :dims))</span></span>
<span class="line"><span>‚îÇ   %8  = Core.apply_type(Core.NamedTuple, %7)::Core.Const(NamedTuple{(:type, :dims)})</span></span>
<span class="line"><span>‚îÇ   %9  = Main.var&quot;Main&quot;.Operator::Core.Const(Operator)</span></span>
<span class="line"><span>‚îÇ   %10 = Core.tuple(%9, dims)::Tuple{OperatorQuantumObject, Tuple{Int64, Int64, Int64}}</span></span>
<span class="line"><span>‚îÇ   %11 = (%8)(%10)::@NamedTuple{type::OperatorQuantumObject, dims::Tuple{Int64, Int64, Int64}}</span></span>
<span class="line"><span>‚îÇ   %12 = Main.var&quot;Main&quot;.Qobj::Core.Const(QuantumToolbox.Qobj)</span></span>
<span class="line"><span>‚îÇ         (op = Core.kwcall(%11, %12, %6))</span></span>
<span class="line"><span>‚îÇ   %14 = op::QuantumObject{Matrix{Float64}, OperatorQuantumObject, 3}</span></span>
<span class="line"><span>‚îÇ         (op_dims = Base.getproperty(%14, :dims))</span></span>
<span class="line"><span>‚îÇ   %16 = op::QuantumObject{Matrix{Float64}, OperatorQuantumObject, 3}</span></span>
<span class="line"><span>‚îÇ         (op_data = Base.getproperty(%16, :data))</span></span>
<span class="line"><span>‚îÇ   %18 = Main.var&quot;Main&quot;.reshape::Core.Const(reshape)</span></span>
<span class="line"><span>‚îÇ   %19 = op_data::Matrix{Float64}</span></span>
<span class="line"><span>‚îÇ   %20 = Core.tuple(%19)::Tuple{Matrix{Float64}}</span></span>
<span class="line"><span>‚îÇ   %21 = Main.var&quot;Main&quot;.vcat::Core.Const(vcat)</span></span>
<span class="line"><span>‚îÇ   %22 = op_dims::SVector{3, Int64}</span></span>
<span class="line"><span>‚îÇ   %23 = op_dims::SVector{3, Int64}</span></span>
<span class="line"><span>‚îÇ   %24 = (%21)(%22, %23)::SVector{6, Int64}</span></span>
<span class="line"><span>‚îÇ   %25 = Core._apply_iterate(Base.iterate, %18, %20, %24)::Array{Float64, 6}</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ       return %25</span></span></code></pre></div><p>Finally, let&#39;s look at the benchmarks</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>BenchmarkTools.Trial: 10000 samples with 8 evaluations.</span></span>
<span class="line"><span> Range (min ‚Ä¶ max):  2.957 Œºs ‚Ä¶  12.319 Œºs  ‚îä GC (min ‚Ä¶ max): 0.00% ‚Ä¶ 0.00%</span></span>
<span class="line"><span> Time  (median):     3.373 Œºs               ‚îä GC (median):    0.00%</span></span>
<span class="line"><span> Time  (mean ¬± œÉ):   3.455 Œºs ¬± 326.313 ns  ‚îä GC (mean ¬± œÉ):  0.00% ¬± 0.00%</span></span>
<span class="line"><span></span></span>
<span class="line"><span>           ‚ñÑ‚ñà‚ñÖ‚ñÅ    ‚ñÉ‚ñÅ                                          </span></span>
<span class="line"><span>  ‚ñÅ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÅ‚ñÅ‚ñÅ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñÖ‚ñÑ‚ñÑ‚ñá‚ñà‚ñà‚ñÖ‚ñÉ‚ñÇ‚ñÇ‚ñÉ‚ñÑ‚ñÉ‚ñÇ‚ñÇ‚ñÅ‚ñÅ‚ñÅ‚ñÇ‚ñÇ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ ‚ñÇ</span></span>
<span class="line"><span>  2.96 Œºs         Histogram: frequency by time        4.78 Œºs &lt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> Memory estimate: 1.69 KiB, allocs estimate: 32.</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>BenchmarkTools.Trial: 10000 samples with 328 evaluations.</span></span>
<span class="line"><span> Range (min ‚Ä¶ max):  195.427 ns ‚Ä¶ 169.226 Œºs  ‚îä GC (min ‚Ä¶ max):  0.00% ‚Ä¶ 99.78%</span></span>
<span class="line"><span> Time  (median):     448.265 ns               ‚îä GC (median):     0.00%</span></span>
<span class="line"><span> Time  (mean ¬± œÉ):   440.507 ns ¬±   2.789 Œºs  ‚îä GC (mean ¬± œÉ):  17.25% ¬±  4.03%</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   ‚ñá‚ñÜ                                           ‚ñÉ‚ñà‚ñÜ‚ñÅ             </span></span>
<span class="line"><span>  ‚ñÑ‚ñà‚ñà‚ñÜ‚ñÉ‚ñÉ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÅ‚ñÅ‚ñÇ‚ñÅ‚ñÅ‚ñÇ‚ñÇ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÅ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÖ‚ñà‚ñà‚ñà‚ñà‚ñÖ‚ñÑ‚ñÑ‚ñÑ‚ñÉ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ‚ñÇ ‚ñÉ</span></span>
<span class="line"><span>  195 ns           Histogram: frequency by time          525 ns &lt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span> Memory estimate: 672 bytes, allocs estimate: 3.</span></span></code></pre></div><p>Which is an innocuous but huge difference in terms of performance. Hence, we highly recommend using <code>Tuple</code> or <code>SVector</code> when defining the dimensions of a user-defined <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a>.</p><h2 id="The-use-of-Val-in-some-QuantumToolbox.jl-functions" tabindex="-1">The use of <code>Val</code> in some <code>QuantumToolbox.jl</code> functions <a class="header-anchor" href="#The-use-of-Val-in-some-QuantumToolbox.jl-functions" aria-label="Permalink to &quot;The use of `Val` in some `QuantumToolbox.jl` functions {#The-use-of-Val-in-some-QuantumToolbox.jl-functions}&quot;">‚Äã</a></h2><p>In some functions of <code>QuantumToolbox.jl</code>, you may find the use of the <a href="https://docs.julialang.org/en/v1/base/base/#Base.Val" target="_blank" rel="noreferrer"><code>Val</code></a> type in the arguments. This is a trick to pass a value at compile time, and it is very useful to avoid type instabilities. Let&#39;s make a very simple example, where we want to create a Fock state <mjx-container class="MathJax" jax="SVG" style="direction:ltr;position:relative;"><svg style="overflow:visible;min-height:1px;min-width:1px;vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="2.441ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1079 1000" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z" style="stroke-width:3;"></path></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z" style="stroke-width:3;"></path></g><g data-mml-node="mo" transform="translate(690,0)"><path data-c="27E9" d="M55 732Q56 739 61 744T75 750Q85 750 92 740Q95 733 186 494T278 250T187 6T92 -240Q85 -250 75 -250Q67 -250 62 -245T55 -232Q55 -227 145 11Q236 248 236 250T145 489Q55 727 55 732Z" style="stroke-width:3;"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline" style="top:0px;left:0px;clip:rect(1px, 1px, 1px, 1px);-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:absolute;padding:1px 0px 0px 0px;border:0px;display:block;width:auto;overflow:hidden;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo data-mjx-texclass="ORD" stretchy="false">|</mo><mi>j</mi><mo fence="false" stretchy="false">‚ü©</mo></math></mjx-assistive-mml></mjx-container> of a given dimension <code>N</code>, and we give the possibility to create it as a sparse or dense vector. At first, we can write the function without using <code>Val</code>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sparse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sparsevec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], N)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ComplexF64, N)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array[j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> QuantumObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(array; type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ket)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>my_fock(2, 1) = Quantum Object:   type=Ket   dims=[2]   size=(2,)</span></span>
<span class="line"><span>2-element Vector{ComplexF64}:</span></span>
<span class="line"><span> 0.0 + 0.0im</span></span>
<span class="line"><span> 1.0 + 0.0im</span></span>
<span class="line"><span>my_fock(2, 1; sparse = true) = Quantum Object:   type=Ket   dims=[2]   size=(2,)</span></span>
<span class="line"><span>2-element SparseVector{ComplexF64, Int64} with 1 stored entry:</span></span>
<span class="line"><span>  [2]  =  1.0+0.0im</span></span></code></pre></div><p>But it is immediately clear that the return type of this function is not clear, because it depends on the value of the <code>sparse</code> argument. We can check it using the <code>@code_warntype</code> macro:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Main.var&quot;Main&quot;.my_fock(::Int64, ::Int64)</span></span>
<span class="line"><span>  from my_fock(N::Int64, j::Int64; sparse) @ Main.var&quot;Main&quot; type_stability.md:229</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #self#::Core.Const(Main.var&quot;Main&quot;.my_fock)</span></span>
<span class="line"><span>  N::Int64</span></span>
<span class="line"><span>  j::Int64</span></span>
<span class="line"><span>Body::UNION{QUANTUMOBJECT{VECTOR{COMPLEXF64}, KETQUANTUMOBJECT, 1}, QUANTUMOBJECT{SPARSEVECTOR{COMPLEXF64, INT64}, KETQUANTUMOBJECT, 1}}</span></span>
<span class="line"><span>1 ‚îÄ %1 = Main.var&quot;Main&quot;.:(var&quot;#my_fock#1&quot;)::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock#1&quot;)</span></span>
<span class="line"><span>‚îÇ   %2 = (%1)(false, #self#, N, j)::UNION{QUANTUMOBJECT{VECTOR{COMPLEXF64}, KETQUANTUMOBJECT, 1}, QUANTUMOBJECT{SPARSEVECTOR{COMPLEXF64, INT64}, KETQUANTUMOBJECT, 1}}</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ      return %2</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Core.kwcall(::@NamedTuple{sparse::Bool}, ::typeof(Main.var&quot;Main&quot;.my_fock), ::Int64, ::Int64)</span></span>
<span class="line"><span>  from kwcall(::NamedTuple, ::typeof(Main.var&quot;Main&quot;.my_fock), N::Int64, j::Int64) @ Main.var&quot;Main&quot; type_stability.md:229</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #s6::Core.Const(Core.kwcall)</span></span>
<span class="line"><span>  @_2::@NamedTuple{sparse::Bool}</span></span>
<span class="line"><span>  @_3::Core.Const(Main.var&quot;Main&quot;.my_fock)</span></span>
<span class="line"><span>  N::Int64</span></span>
<span class="line"><span>  j::Int64</span></span>
<span class="line"><span>Locals</span></span>
<span class="line"><span>  sparse::Union{}</span></span>
<span class="line"><span>  @_7::Bool</span></span>
<span class="line"><span>Body::UNION{QUANTUMOBJECT{VECTOR{COMPLEXF64}, KETQUANTUMOBJECT, 1}, QUANTUMOBJECT{SPARSEVECTOR{COMPLEXF64, INT64}, KETQUANTUMOBJECT, 1}}</span></span>
<span class="line"><span>1 ‚îÄ‚îÄ       Core.NewvarNode(:(sparse))</span></span>
<span class="line"><span>‚îÇ          Core.NewvarNode(:(@_7))</span></span>
<span class="line"><span>‚îÇ    %3  = Core.isdefined(@_2, :sparse)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #6 if not %3</span></span>
<span class="line"><span>2 ‚îÄ‚îÄ %5  = Core.getfield(@_2, :sparse)::Bool</span></span>
<span class="line"><span>‚îÇ    %6  = Main.var&quot;Main&quot;.Bool::Core.Const(Bool)</span></span>
<span class="line"><span>‚îÇ    %7  = (%5 isa %6)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #4 if not %7</span></span>
<span class="line"><span>3 ‚îÄ‚îÄ       goto #5</span></span>
<span class="line"><span>4 ‚îÄ‚îÄ       Core.Const(:(Main.var&quot;Main&quot;.Bool))</span></span>
<span class="line"><span>‚îÇ          Core.Const(:(%new(Core.TypeError, Symbol(&quot;keyword argument&quot;), :sparse, %10, %5)))</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       Core.Const(:(Core.throw(%11)))</span></span>
<span class="line"><span>5 ‚îÑ‚îÄ       (@_7 = %5)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #7</span></span>
<span class="line"><span>6 ‚îÄ‚îÄ       Core.Const(:(@_7 = false))</span></span>
<span class="line"><span>7 ‚îÑ‚îÄ %16 = @_7::Bool</span></span>
<span class="line"><span>‚îÇ    %17 = Base.keys(@_2)::Core.Const((:sparse,))</span></span>
<span class="line"><span>‚îÇ    %18 = (:sparse,)::Core.Const((:sparse,))</span></span>
<span class="line"><span>‚îÇ    %19 = Base.diff_names(%17, %18)::Core.Const(())</span></span>
<span class="line"><span>‚îÇ    %20 = Base.isempty(%19)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #9 if not %20</span></span>
<span class="line"><span>8 ‚îÄ‚îÄ       goto #10</span></span>
<span class="line"><span>9 ‚îÄ‚îÄ       Core.Const(:(Base.kwerr(@_2, @_3, N, j)))</span></span>
<span class="line"><span>10 ‚îÑ %24 = Main.var&quot;Main&quot;.:(var&quot;#my_fock#1&quot;)::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock#1&quot;)</span></span>
<span class="line"><span>‚îÇ    %25 = (%24)(%16, @_3, N, j)::UNION{QUANTUMOBJECT{VECTOR{COMPLEXF64}, KETQUANTUMOBJECT, 1}, QUANTUMOBJECT{SPARSEVECTOR{COMPLEXF64, INT64}, KETQUANTUMOBJECT, 1}}</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       return %25</span></span></code></pre></div><p>We can fix this by using the <code>Val</code> type, where we enable the multiple dispatch of the function:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getVal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Val{N}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Val</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> getVal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sparse)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ComplexF64, N)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array[j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sparsevec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], N)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> QuantumObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(array; type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ket)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>my_fock_good(2, 1) = Quantum Object:   type=Ket   dims=[2]   size=(2,)</span></span>
<span class="line"><span>2-element SparseVector{ComplexF64, Int64} with 1 stored entry:</span></span>
<span class="line"><span>  [2]  =  1.0+0.0im</span></span>
<span class="line"><span>my_fock_good(2, 1; sparse = Val(true)) = Quantum Object:   type=Ket   dims=[2]   size=(2,)</span></span>
<span class="line"><span>2-element Vector{ComplexF64}:</span></span>
<span class="line"><span> 0.0 + 0.0im</span></span>
<span class="line"><span> 1.0 + 0.0im</span></span></code></pre></div><p>And now the return type of the function is clear:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Main.var&quot;Main&quot;.my_fock_good(::Int64, ::Int64)</span></span>
<span class="line"><span>  from my_fock_good(N::Int64, j::Int64; sparse) @ Main.var&quot;Main&quot; type_stability.md:257</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #self#::Core.Const(Main.var&quot;Main&quot;.my_fock_good)</span></span>
<span class="line"><span>  N::Int64</span></span>
<span class="line"><span>  j::Int64</span></span>
<span class="line"><span>Body::QuantumObject{SparseVector{ComplexF64, Int64}, KetQuantumObject, 1}</span></span>
<span class="line"><span>1 ‚îÄ %1 = Main.var&quot;Main&quot;.:(var&quot;#my_fock_good#2&quot;)::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock_good#2&quot;)</span></span>
<span class="line"><span>‚îÇ   %2 = Main.var&quot;Main&quot;.Val(false)::Core.Const(Val{false}())</span></span>
<span class="line"><span>‚îÇ   %3 = (%1)(%2, #self#, N, j)::QuantumObject{SparseVector{ComplexF64, Int64}, KetQuantumObject, 1}</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ      return %3</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>MethodInstance for Core.kwcall(::@NamedTuple{sparse::Val{true}}, ::typeof(Main.var&quot;Main&quot;.my_fock_good), ::Int64, ::Int64)</span></span>
<span class="line"><span>  from kwcall(::NamedTuple, ::typeof(Main.var&quot;Main&quot;.my_fock_good), N::Int64, j::Int64) @ Main.var&quot;Main&quot; type_stability.md:257</span></span>
<span class="line"><span>Arguments</span></span>
<span class="line"><span>  #s6::Core.Const(Core.kwcall)</span></span>
<span class="line"><span>  @_2::Core.Const((sparse = Val{true}(),))</span></span>
<span class="line"><span>  @_3::Core.Const(Main.var&quot;Main&quot;.my_fock_good)</span></span>
<span class="line"><span>  N::Int64</span></span>
<span class="line"><span>  j::Int64</span></span>
<span class="line"><span>Locals</span></span>
<span class="line"><span>  sparse::Union{}</span></span>
<span class="line"><span>  @_7::Val{true}</span></span>
<span class="line"><span>Body::QuantumObject{Vector{ComplexF64}, KetQuantumObject, 1}</span></span>
<span class="line"><span>1 ‚îÄ‚îÄ       Core.NewvarNode(:(sparse))</span></span>
<span class="line"><span>‚îÇ          Core.NewvarNode(:(@_7))</span></span>
<span class="line"><span>‚îÇ    %3  = Core.isdefined(@_2, :sparse)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #6 if not %3</span></span>
<span class="line"><span>2 ‚îÄ‚îÄ %5  = Core.getfield(@_2, :sparse)::Core.Const(Val{true}())</span></span>
<span class="line"><span>‚îÇ    %6  = (%5 isa Main.var&quot;Main&quot;.Val)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #4 if not %6</span></span>
<span class="line"><span>3 ‚îÄ‚îÄ       goto #5</span></span>
<span class="line"><span>4 ‚îÄ‚îÄ       Core.Const(:(%new(Core.TypeError, Symbol(&quot;keyword argument&quot;), :sparse, Main.var&quot;Main&quot;.Val, %5)))</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       Core.Const(:(Core.throw(%9)))</span></span>
<span class="line"><span>5 ‚îÑ‚îÄ       (@_7 = %5)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #7</span></span>
<span class="line"><span>6 ‚îÄ‚îÄ       Core.Const(:(@_7 = Main.var&quot;Main&quot;.Val(false)))</span></span>
<span class="line"><span>7 ‚îÑ‚îÄ %14 = @_7::Core.Const(Val{true}())</span></span>
<span class="line"><span>‚îÇ    %15 = Base.keys(@_2)::Core.Const((:sparse,))</span></span>
<span class="line"><span>‚îÇ    %16 = (:sparse,)::Core.Const((:sparse,))</span></span>
<span class="line"><span>‚îÇ    %17 = Base.diff_names(%15, %16)::Core.Const(())</span></span>
<span class="line"><span>‚îÇ    %18 = Base.isempty(%17)::Core.Const(true)</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       goto #9 if not %18</span></span>
<span class="line"><span>8 ‚îÄ‚îÄ       goto #10</span></span>
<span class="line"><span>9 ‚îÄ‚îÄ       Core.Const(:(Base.kwerr(@_2, @_3, N, j)))</span></span>
<span class="line"><span>10 ‚îÑ %22 = Main.var&quot;Main&quot;.:(var&quot;#my_fock_good#2&quot;)::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock_good#2&quot;)</span></span>
<span class="line"><span>‚îÇ    %23 = (%22)(%14, @_3, N, j)::QuantumObject{Vector{ComplexF64}, KetQuantumObject, 1}</span></span>
<span class="line"><span>‚îî‚îÄ‚îÄ‚îÄ       return %23</span></span></code></pre></div><p>This is exactly how the current <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.fock"><code>fock</code></a> function is implemented in <code>QuantumToolbox.jl</code>. There are many other functions that support this feature, and we highly recommend using it when necessary.</p><h2 id="conclusions" tabindex="-1">Conclusions <a class="header-anchor" href="#conclusions" aria-label="Permalink to &quot;Conclusions&quot;">‚Äã</a></h2><p>In this page, we have seen the importance of type stability in Julia, and how to write efficient code in the context of <code>QuantumToolbox.jl</code>. We have seen that the internal structure of the <a href="/QuantumToolbox.jl/v0.21.3/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a> type is already optimized for the compiler, and we have seen some practical examples of how to write efficient code. We have seen that the use of <code>Vector</code> should be avoided when the elements don&#39;t have the same type, and that the use of <code>Tuple</code> or <code>SVector</code> is highly recommended when the size of the array is known at compile time. Finally, we have seen the use of <code>Val</code> to pass values at compile time, to avoid type instabilities in some functions. ```</p></div></div></main><footer class="VPDocFooter" data-v-83890dd9 data-v-4f9813fa><!--[--><!--]--><div class="edit-info" data-v-4f9813fa><div class="edit-link" data-v-4f9813fa><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/qutip/QuantumToolbox.jl/edit/main/docs/src/type_stability.md" target="_blank" rel="noreferrer" data-v-4f9813fa><!--[--><span class="vpi-square-pen edit-link-icon" data-v-4f9813fa></span> Edit this page<!--]--></a></div><!----></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-4f9813fa><span class="visually-hidden" id="doc-footer-aria-label" data-v-4f9813fa>Pager</span><div class="pager" data-v-4f9813fa><a class="VPLink link pager-link prev" href="/QuantumToolbox.jl/v0.21.3/qutip_differences" data-v-4f9813fa><!--[--><span class="desc" data-v-4f9813fa>Previous page</span><span class="title" data-v-4f9813fa>Key differences from QuTiP</span><!--]--></a></div><div class="pager" data-v-4f9813fa><a class="VPLink link pager-link next" href="/QuantumToolbox.jl/v0.21.3/users_guide/QuantumObject/QuantumObject" data-v-4f9813fa><!--[--><span class="desc" data-v-4f9813fa>Next page</span><span class="title" data-v-4f9813fa>Quantum Objects (Qobj)</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-a9a9e638 data-v-c970a860><div class="container" data-v-c970a860><p class="message" data-v-c970a860>Made with <a href="https://documenter.juliadocs.org/stable/" target="_blank"><strong>Documenter.jl</strong></a>, <a href="https://vitepress.dev" target="_blank"><strong>VitePress</strong></a> and <a href="https://luxdl.github.io/DocumenterVitepress.jl/stable" target="_blank"><strong>DocumenterVitepress.jl</strong></a><br>Released under the BSD 3-Clause License. Powered by the <a href="https://www.julialang.org" target="_blank">Julia Programming Language</a>.<br></p><p class="copyright" data-v-c970a860>¬© Copyright 2024 <a href="https://qutip.org/" target="_blank"><strong>QuTiP.org</strong></a>.</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"getting_started.md\":\"DNKfogBT\",\"index.md\":\"BL-HjZtZ\",\"qutip_differences.md\":\"DInhbpO4\",\"resources_api.md\":\"CGDhmASb\",\"resources_bibliography.md\":\"B-ReqEb6\",\"tutorials_logo.md\":\"2hHf3k5M\",\"tutorials_lowrank.md\":\"DMNTQu-R\",\"type_stability.md\":\"DYoCA6vB\",\"users_guide_extensions_cuda.md\":\"BFvFK1RU\",\"users_guide_quantumobject_quantumobject.md\":\"Der_g3FP\",\"users_guide_quantumobject_quantumobject_functions.md\":\"B5XXmDxq\",\"users_guide_states_and_operators.md\":\"D0a4rOX8\",\"users_guide_steadystate.md\":\"AcoHcR-r\",\"users_guide_tensor.md\":\"BR0h3Ecx\",\"users_guide_time_evolution_intro.md\":\"GM-O4o9k\",\"users_guide_time_evolution_mcsolve.md\":\"Ddy5Spew\",\"users_guide_time_evolution_mesolve.md\":\"luSfdsRn\",\"users_guide_time_evolution_sesolve.md\":\"nSvugmS7\",\"users_guide_time_evolution_solution.md\":\"B2tBeBj5\",\"users_guide_time_evolution_stochastic.md\":\"BfmNdQhd\",\"users_guide_time_evolution_time_dependent.md\":\"DclbfJEb\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"QuantumToolbox.jl\",\"description\":\"Documentation for QuantumToolbox.jl\",\"base\":\"/QuantumToolbox.jl/v0.21.3/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"outline\":\"deep\",\"logo\":{\"src\":\"/logo.png\",\"width\":24,\"height\":24},\"search\":{\"provider\":\"local\",\"options\":{\"detailedView\":true}},\"nav\":[{\"text\":\"Home\",\"link\":\"/index\"},{\"text\":\"Getting Started\",\"collapsed\":false,\"items\":[{\"text\":\"Brief Example\",\"link\":\"/getting_started\"},{\"text\":\"Key differences from QuTiP\",\"link\":\"/qutip_differences\"},{\"text\":\"The Importance of Type-Stability\",\"link\":\"/type_stability\"}]},{\"text\":\"Users Guide\",\"collapsed\":false,\"items\":[{\"text\":\"Basic Operations on Quantum Objects\",\"collapsed\":false,\"items\":[{\"text\":\"Quantum Objects (Qobj)\",\"link\":\"/users_guide/QuantumObject/QuantumObject\"},{\"text\":\"Functions operating on Qobj\",\"link\":\"/users_guide/QuantumObject/QuantumObject_functions\"}]},{\"text\":\"Manipulating States and Operators\",\"link\":\"/users_guide/states_and_operators\"},{\"text\":\"Tensor Products and Partial Traces\",\"link\":\"/users_guide/tensor\"},{\"text\":\"Time Evolution and Dynamics\",\"collapsed\":false,\"items\":[{\"text\":\"Introduction\",\"link\":\"/users_guide/time_evolution/intro\"},{\"text\":\"Time Evolution Solutions\",\"link\":\"/users_guide/time_evolution/solution\"},{\"text\":\"Schr√∂dinger Equation Solver\",\"link\":\"/users_guide/time_evolution/sesolve\"},{\"text\":\"Lindblad Master Equation Solver\",\"link\":\"/users_guide/time_evolution/mesolve\"},{\"text\":\"Monte-Carlo Solver\",\"link\":\"/users_guide/time_evolution/mcsolve\"},{\"text\":\"Stochastic Solver\",\"link\":\"/users_guide/time_evolution/stochastic\"},{\"text\":\"Solving Problems with Time-dependent Hamiltonians\",\"link\":\"/users_guide/time_evolution/time_dependent\"}]},{\"text\":\"Solving for Steady-State Solutions\",\"link\":\"/users_guide/steadystate\"},{\"text\":\"Symmetries\",\"collapsed\":false,\"items\":[]},{\"text\":\"Two-time correlation functions\",\"collapsed\":false,\"items\":[]},{\"text\":\"Extensions\",\"collapsed\":false,\"items\":[{\"text\":\"Extension for CUDA.jl\",\"link\":\"/users_guide/extensions/cuda\"}]}]},{\"text\":\"Tutorials\",\"collapsed\":false,\"items\":[{\"text\":\"Time Evolution\",\"collapsed\":false,\"items\":[{\"text\":\"Low Rank Master Equation\",\"link\":\"/tutorials/lowrank\"}]},{\"text\":\"Miscellaneous Tutorials\",\"collapsed\":false,\"items\":[{\"text\":\"Create QuantumToolbox.jl logo\",\"link\":\"/tutorials/logo\"}]}]},{\"text\":\"Resources\",\"collapsed\":false,\"items\":[{\"text\":\"API\",\"link\":\"/resources/api\"},{\"text\":\"Bibliography\",\"link\":\"/resources/bibliography\"}]},{\"text\":\"Benchmarks\",\"link\":\"https://qutip.org/QuantumToolbox.jl/benchmarks/\"},{\"component\":\"VersionPicker\"}],\"sidebar\":[{\"text\":\"Home\",\"link\":\"/index\"},{\"text\":\"Getting Started\",\"collapsed\":false,\"items\":[{\"text\":\"Brief Example\",\"link\":\"/getting_started\"},{\"text\":\"Key differences from QuTiP\",\"link\":\"/qutip_differences\"},{\"text\":\"The Importance of Type-Stability\",\"link\":\"/type_stability\"}]},{\"text\":\"Users Guide\",\"collapsed\":false,\"items\":[{\"text\":\"Basic Operations on Quantum Objects\",\"collapsed\":false,\"items\":[{\"text\":\"Quantum Objects (Qobj)\",\"link\":\"/users_guide/QuantumObject/QuantumObject\"},{\"text\":\"Functions operating on Qobj\",\"link\":\"/users_guide/QuantumObject/QuantumObject_functions\"}]},{\"text\":\"Manipulating States and Operators\",\"link\":\"/users_guide/states_and_operators\"},{\"text\":\"Tensor Products and Partial Traces\",\"link\":\"/users_guide/tensor\"},{\"text\":\"Time Evolution and Dynamics\",\"collapsed\":false,\"items\":[{\"text\":\"Introduction\",\"link\":\"/users_guide/time_evolution/intro\"},{\"text\":\"Time Evolution Solutions\",\"link\":\"/users_guide/time_evolution/solution\"},{\"text\":\"Schr√∂dinger Equation Solver\",\"link\":\"/users_guide/time_evolution/sesolve\"},{\"text\":\"Lindblad Master Equation Solver\",\"link\":\"/users_guide/time_evolution/mesolve\"},{\"text\":\"Monte-Carlo Solver\",\"link\":\"/users_guide/time_evolution/mcsolve\"},{\"text\":\"Stochastic Solver\",\"link\":\"/users_guide/time_evolution/stochastic\"},{\"text\":\"Solving Problems with Time-dependent Hamiltonians\",\"link\":\"/users_guide/time_evolution/time_dependent\"}]},{\"text\":\"Solving for Steady-State Solutions\",\"link\":\"/users_guide/steadystate\"},{\"text\":\"Symmetries\",\"collapsed\":false,\"items\":[]},{\"text\":\"Two-time correlation functions\",\"collapsed\":false,\"items\":[]},{\"text\":\"Extensions\",\"collapsed\":false,\"items\":[{\"text\":\"Extension for CUDA.jl\",\"link\":\"/users_guide/extensions/cuda\"}]}]},{\"text\":\"Tutorials\",\"collapsed\":false,\"items\":[{\"text\":\"Time Evolution\",\"collapsed\":false,\"items\":[{\"text\":\"Low Rank Master Equation\",\"link\":\"/tutorials/lowrank\"}]},{\"text\":\"Miscellaneous Tutorials\",\"collapsed\":false,\"items\":[{\"text\":\"Create QuantumToolbox.jl logo\",\"link\":\"/tutorials/logo\"}]}]},{\"text\":\"Resources\",\"collapsed\":false,\"items\":[{\"text\":\"API\",\"link\":\"/resources/api\"},{\"text\":\"Bibliography\",\"link\":\"/resources/bibliography\"}]}],\"editLink\":{\"pattern\":\"https://github.com/qutip/QuantumToolbox.jl/edit/main/docs/src/:path\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/qutip/QuantumToolbox.jl\"}],\"footer\":{\"message\":\"Made with <a href=\\\"https://documenter.juliadocs.org/stable/\\\" target=\\\"_blank\\\"><strong>Documenter.jl</strong></a>, <a href=\\\"https://vitepress.dev\\\" target=\\\"_blank\\\"><strong>VitePress</strong></a> and <a href=\\\"https://luxdl.github.io/DocumenterVitepress.jl/stable\\\" target=\\\"_blank\\\"><strong>DocumenterVitepress.jl</strong></a><br>Released under the BSD 3-Clause License. Powered by the <a href=\\\"https://www.julialang.org\\\" target=\\\"_blank\\\">Julia Programming Language</a>.<br>\",\"copyright\":\"¬© Copyright 2024 <a href=\\\"https://qutip.org/\\\" target=\\\"_blank\\\"><strong>QuTiP.org</strong></a>.\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>