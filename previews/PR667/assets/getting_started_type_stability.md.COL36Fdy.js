import{_ as h,o as n,c as t,aA as e,j as i,a}from"./chunks/framework.CleWuXpX.js";const E=JSON.parse('{"title":"The Importance of Type-Stability","description":"","frontmatter":{},"headers":[],"relativePath":"getting_started/type_stability.md","filePath":"getting_started/type_stability.md","lastUpdated":null}'),l={name:"getting_started/type_stability.md"},k={class:"MathJax",jax:"SVG",overflow:"linebreak"},p={style:{"vertical-align":"-0.332ex"},xmlns:"http://www.w3.org/2000/svg",width:"3.524ex",height:"2.725ex",role:"img",focusable:"false",viewBox:"0 -1057.9 1557.7 1204.6"},d={class:"MathJax",jax:"SVG",overflow:"linebreak"},r={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.441ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 1079 1000"};function o(g,s,y,c,u,C){return n(),t("div",null,[s[16]||(s[16]=e(`<h1 id="doc:Type-Stability" tabindex="-1">The Importance of Type-Stability <a class="header-anchor" href="#doc:Type-Stability" aria-label="Permalink to &quot;The Importance of Type-Stability {#doc:Type-Stability}&quot;">​</a></h1><p>You are here because you have probably heard about the excellent performance of Julia compared to other common programming languages like Python. One of the reasons is the Just-In-Time (JIT) compiler of Julia, which is able to generate highly optimized machine code. However, the JIT compiler can only do its job if the code type can be inferred. You can also read the <a href="https://docs.julialang.org/en/v1/manual/performance-tips/" target="_blank" rel="noreferrer">Performance Tips</a> section in Julia&#39;s documentation for more details. Here, we try to explain it briefly, with a focus on the <code>QuantumToolbox.jl</code> package.</p><div class="tip custom-block"><p class="custom-block-title">Note</p><p>This page is not a tutorial on <code>QuantumToolbox.jl</code>, but rather a general guide to writing Julia code for simulating quantum systems efficiently. If you don&#39;t care about the performance of your code, you can skip this page.</p></div><h2 id="Basics-of-type-stability" tabindex="-1">Basics of type stability <a class="header-anchor" href="#Basics-of-type-stability" aria-label="Permalink to &quot;Basics of type stability {#Basics-of-type-stability}&quot;">​</a></h2><p>Let&#39;s have a look at the following example:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The function <code>foo</code> apparently seems to be innocent. It takes an argument <code>x</code> and returns either <code>1</code> or <code>-1.0</code> depending on the sign of <code>x</code>. However, the return type of <code>foo</code> is not clear. If <code>x</code> is positive, the return type is <code>Int</code>, otherwise it is <code>Float64</code>. This is a problem for the JIT compiler, because it has to determine the return type of <code>foo</code> at runtime. This is called type instability (even though it is a weak form) and may lead to a significant performance penalty. To avoid this, always aim for type-stable code. This means that the return type of a function should be clear from the types of its arguments. We can check the inferred return type of <code>foo</code> using the <code>@code_warntype</code> macro:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Main.var&quot;Main&quot;.foo(::Int64)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from foo(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">x</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:18</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #self#</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.foo)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  x</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{Float64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %1 = Main.var&quot;Main&quot;.:&gt;</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(&gt;)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %2 = (%1)(x, 0)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Bool</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">      goto #3 if not %2</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">2 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">      return 1</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">3 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">      return -1.0</span></span></code></pre></div><p>The key point is to ensure the return type of a function is clear from the types of its arguments. There are several ways to achieve this, and the best approach depends on the specific problem. For example, one can use the same return type:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>Or you can ensure the return type matches the type of the argument:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> T</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The latter example is very important because it takes advantage of Julia&#39;s multiple dispatch, which is one of the most powerful features of the language. Depending on the type <code>T</code> of the argument <code>x</code>, the Julia compiler generates a specialized version of <code>foo</code> that is optimized for this type. If the input type is an <code>Int64</code>, the return type is <code>Int64</code>, if <code>x</code> is a <code>Float64</code>, the return type is <code>Float64</code>, and so on.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">//</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">foo(1) = 1</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">foo(-4.4) = -1.0</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">foo(1 // 2) = 1//1</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">Note</p><p>If you didn&#39;t know how to make this function type-stable, it is probably a good idea to read the official Julia documentation, and in particular its <a href="https://docs.julialang.org/en/v1/manual/performance-tips/" target="_blank" rel="noreferrer">Performance Tips</a> section.</p></div><h2 id="Global-variables" tabindex="-1">Global variables <a class="header-anchor" href="#Global-variables" aria-label="Permalink to &quot;Global variables {#Global-variables}&quot;">​</a></h2><p>Another source of type instability is the use of global variables. In general, it is a good idea to declare global variables as <code>const</code> to ensure their type is fixed for the entire program. For example, consider the following function that internally takes a global variable <code>y</code>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zero</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this returns the zero of the same type of x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The Julia compiler cannot infer the type of <code>res</code> because it depends on the type of <code>y</code>, which is a global variable that can change at any time of the program. We can check it using the <code>@code_warntype</code> macro:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Main.var&quot;Main&quot;.bar(::Float64)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from bar(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">x</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:79</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #self#</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.bar)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  x</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Float64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Locals</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_3</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{Nothing, Tuple{Int64, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  res</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  i</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %1  = Main.var&quot;Main&quot;.zero</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(zero)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (res = (%1)(x))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %3  = Main.var&quot;Main&quot;.:(:)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Colon())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %4  = (%3)(1, 1000)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(1:1000)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (@_3 = Base.iterate(%4))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %6  = @_3</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((1, 1))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %7  = (%6 === nothing)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(false)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %8  = Base.not_int(%7)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #4 if not %8</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">2 ┄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %10 = @_3</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (i = Core.getfield(%10, 1))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %12 = Core.getfield(%10, 2)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %13 = Main.var&quot;Main&quot;.:+</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(+)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %14 = res</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %15 = Main.var&quot;Main&quot;.:*</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(*)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %16 = (%15)(Main.var&quot;Main&quot;.y, x)</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (res = (%13)(%14, %16))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (@_3 = Base.iterate(%4, %12))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %19 = @_3</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{Nothing, Tuple{Int64, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %20 = (%19 === nothing)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Bool</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %21 = Base.not_int(%20)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Bool</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #4 if not %21</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">3 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #2</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">4 ┄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %24 = res</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       return %24</span></span></code></pre></div><p>While in the last example of the <code>foo</code> function we got a weak form of type instability, returning a <code>Union{Int, Float64}</code>, in this case the return type of <code>bar</code> is <code>Any</code>, meaning that the compiler doesn&#39;t know anything about the return type. Thus, this function has nothing different from a dynamically typed language like Python. We can benchmark the performance of <code>bar</code> using the <a href="https://github.com/JuliaCI/BenchmarkTools.jl" target="_blank" rel="noreferrer">BenchmarkTools.jl</a> package:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BenchmarkTools</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">BenchmarkTools.Trial: 10000 samples with 1 evaluation per sample.</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Range </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">min</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;">max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">43.672 μs</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;"> 49.141 ms</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">min … max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">): </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00% … 99.77%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):     </span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">66.203 μs               </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):    </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">mean</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):   </span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">66.898 μs</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">490.925 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">mean ± σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">7.33% ±  1.00%</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">                             ▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">▂</span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  ▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">                  </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  ▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▆</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">█</span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▇</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▇</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▇</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ▃</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  43.7 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">         Histogram: frequency by time</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">         80.3 μs </span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">&lt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Memory estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">46.88 KiB</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, allocs estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">3000</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">.</span></span></code></pre></div><p>Here we see a lot of memory allocations and low performances in general. To fix this, we can declare a <code>const</code> (constant) variable instead:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zero</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(x) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this returns the zero of the same type of x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        res </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">BenchmarkTools.Trial: 10000 samples with 57 evaluations per sample.</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Range </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">min</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;">max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">868.807 ns</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;"> 2.455 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">min … max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">): </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00% … 0.00%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):     </span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">869.684 ns              </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):    </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">mean</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):   </span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">877.189 ns</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">34.292 ns</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">mean ± σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00% ± 0.00%</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">  █</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">                                                 ▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  ▁</span></span>
<span class="line"><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">  █</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▆</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▆</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▇</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> █</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  869 ns</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">        Histogram: </span><span style="--shiki-light:#959da5;--shiki-light-font-weight:bold;--shiki-dark:#959da5;--shiki-dark-font-weight:bold;">log(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">frequency</span><span style="--shiki-light:#959da5;--shiki-light-font-weight:bold;--shiki-dark:#959da5;--shiki-dark-font-weight:bold;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> by time</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">         1 μs </span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">&lt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Memory estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">0 bytes</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, allocs estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">0</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">.</span></span></code></pre></div><p>And we can see that the performance has improved significantly. Hence, we highly recommend using global variables as <code>const</code>, but only when truly necessary. This choice is problem-dependent, but in the case of <code>QuantumToolbox.jl</code>, this can be applied for example in the case of defining the Hilbert space dimensions, static parameters, or the system operators.</p><p>Although it is always a good practice to avoid such kind of type instabilities, in the actual implementation of <code>QuantumToolbox.jl</code> (where we mainly deal with linear algebra operations), the compiler may perform only a few runtime dispatches, and the performance penalty may be negligible compared to the heavy linear algebra operations.</p><h2 id="Vectors-vs-Tuples-vs-StaticArrays" tabindex="-1">Vectors vs Tuples vs StaticArrays <a class="header-anchor" href="#Vectors-vs-Tuples-vs-StaticArrays" aria-label="Permalink to &quot;Vectors vs Tuples vs StaticArrays {#Vectors-vs-Tuples-vs-StaticArrays}&quot;">​</a></h2><p>Julia has many ways to represent arrays or lists of general objects. The most common are <code>Vector</code>s and <code>Tuple</code>s. The former is a dynamic array that can change its size at runtime, while the latter is a fixed-size array that is immutable, and where the type of each element is already known at compile time. For example:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vector of Int64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vector of ComplexF64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ciao&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vector of Any</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tuple of {Int64, Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4.0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tuple of {ComplexF64, ComplexF64}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ciao&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tuple of {Int64, String, Float64}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v1)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v2)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v3)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t1)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t2)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t3)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">typeof(v1) = Vector{Int64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">typeof(v2) = Vector{ComplexF64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">typeof(v3) = Vector{Any}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">typeof(t1) = Tuple{Int64, Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">typeof(t2) = Tuple{ComplexF64, ComplexF64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">typeof(t3) = Tuple{Int64, String, Float64}</span></span></code></pre></div><p>Thus, we highly recommend using <code>Vector</code> only when we are sure that it contains elements of the same type, and only when we don&#39;t need to know its size at compile time. On the other hand, <code>Tuple</code>s are less flexible but more efficient in terms of performance. A third option is to use the <code>SVector</code> type from the <a href="https://github.com/JuliaArrays/StaticArrays.jl" target="_blank" rel="noreferrer">StaticArrays.jl</a> package. This is similar to <code>Vector</code>, where the elements should have the same type, but it is fixed-size and immutable. One may ask when it is necessary to know the array size at compile time. A practical example is the case of <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.ptrace"><code>ptrace</code></a>, where it internally reshapes the quantum state into a tensor whose dimensions depend on the number of subsystems. We will see this in more detail in the next section.</p><h2 id="The-QuantumObject-internal-structure" tabindex="-1">The <code>QuantumObject</code> internal structure <a class="header-anchor" href="#The-QuantumObject-internal-structure" aria-label="Permalink to &quot;The \`QuantumObject\` internal structure {#The-QuantumObject-internal-structure}&quot;">​</a></h2>`,37)),i("p",null,[s[1]||(s[1]=a("Before making a practical example, let's see the internal structure of the ",-1)),s[2]||(s[2]=i("a",{href:"/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.QuantumObject"},[i("code",null,"QuantumObject")],-1)),s[3]||(s[3]=a(" type. As an example, we consider the case of three qubits, and we study the internal structure of the ",-1)),i("mjx-container",k,[(n(),t("svg",p,[...s[0]||(s[0]=[e('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="\\hat{\\sigma}_x^{(2)}"><g data-mml-node="msubsup" data-latex="\\hat{\\sigma}_x^{(2)}"><g data-mml-node="TeXAtom" data-latex="\\hat{\\sigma}" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi" data-latex="\\sigma"><path data-c="1D70E" d="M525 431L300 431C252 431 207 416 166 385C102 336 38 250 38 148C38 58 100-11 190-11C257-11 317 18 368 76C417 132 441 194 441 263C441 304 432 338 414 366L515 366C550 366 567 378 567 403C567 426 550 431 525 431M107 121C107 180 121 234 150 282C184 338 228 366 283 366C341 366 370 336 370 275C370 250 365 221 355 187C335 116 302 66 256 39C233 25 211 18 191 18C136 18 107 63 107 121Z"></path></g><g data-mml-node="mo" transform="translate(285.5,32) translate(-250 0)"><path data-c="2C6" d="M386 515L403 533L250 694L97 533L114 515L250 618Z"></path></g></g></g><g data-mml-node="TeXAtom" transform="translate(604,529) scale(0.707)" data-latex="{(2)}" data-mjx-texclass="ORD"><g data-mml-node="mo" data-latex="("><path data-c="28" d="M318-248C327-248 332-243 332-234C332-231 330-227 327-223C275-183 233-117 202-26C175 53 161 131 161 208L161 292C161 369 175 447 202 526C233 617 275 683 327 723C330 726 332 730 332 734C332 743 327 748 318 748C317 748 314 747 311 745C251 699 201 631 160 540C121 453 101 371 101 292L101 208C101 129 121 47 160-40C201-131 251-199 311-245C314-247 317-248 318-248Z"></path></g><g data-mml-node="mn" data-latex="2" transform="translate(389,0)"><path data-c="32" d="M237 666C186 666 143 648 106 612C69 576 50 534 50 483C50 449 75 424 106 424C136 424 161 450 161 480C161 513 137 536 105 536C102 536 100 536 98 535C117 584 161 627 224 627C306 627 352 556 352 470C352 403 318 331 250 255L62 43C49 28 50 29 50 0L421 0L450 180L417 180C409 129 402 100 396 91C391 86 361 84 306 84L139 84L236 179C304 243 390 312 419 365C439 400 449 435 449 470C449 588 357 666 237 666Z"></path></g><g data-mml-node="mo" data-latex=")" transform="translate(889,0)"><path data-c="29" d="M78-245C138-199 188-131 229-40C268 47 288 129 288 208L288 292C288 371 268 453 229 540C188 631 138 699 78 745C75 747 72 748 71 748C62 748 57 743 57 734C57 730 59 726 62 723C114 683 156 617 187 526C214 447 228 369 228 292L228 208C228 131 214 53 187-26C156-117 114-183 62-223C59-227 57-231 57-234C57-243 62-248 71-248C72-248 75-247 78-245Z"></path></g></g><g data-mml-node="mi" transform="translate(604,-138.9) scale(0.707)" data-latex="x"><path data-c="1D465" d="M527 373C527 419 482 442 432 442C389 442 355 419 329 373C308 419 273 442 222 442C173 442 133 419 101 374C74 335 60 306 60 287C60 278 65 273 75 273C84 273 90 278 92 287C111 345 153 413 220 413C253 413 269 392 269 351C269 330 251 252 216 118C199 51 169 18 126 18C112 18 99 21 88 26C114 36 127 54 127 80C127 106 114 119 87 119C54 119 29 91 29 58C29 12 76-11 125-11C167-11 201 12 228 58C247 12 283-11 335-11C383-11 423 12 455 57C482 96 496 125 496 144C496 153 491 158 481 158C472 158 467 153 464 144C447 87 402 18 337 18C304 18 287 38 287 79C287 92 292 120 303 165L337 300C356 375 387 413 431 413C445 413 458 410 469 405C442 396 429 378 429 351C429 325 443 312 470 312C502 312 527 341 527 373Z"></path></g></g></g></g>',1)])]))]),s[4]||(s[4]=a(" operator:",-1))]),s[17]||(s[17]=e(`<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">σx_2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tensor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qeye</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sigmax</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">qeye</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Quantum Object:   type=Operator()   dims=([2, 2, 2], [2, 2, 2])   size=(8, 8)   ishermitian=true</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">8×8 SparseArrays.SparseMatrixCSC{ComplexF64, Int64} with 8 stored entries:</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅      1.0+0.0im  …      ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 1.0+0.0im      ⋅          ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅      1.0+0.0im      ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅             ⋅      1.0+0.0im      ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅      …      ⋅          ⋅      1.0+0.0im</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅         1.0+0.0im      ⋅          ⋅</span></span></code></pre></div><p>and its type is</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">obj_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(σx_2)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">QuantumObject{Operator, ProductDimensions{3, 3, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}}, SparseArrays.SparseMatrixCSC{ComplexF64, Int64}}</span></span></code></pre></div><p>This is exactly what the Julia compiler sees: it is a <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a>, composed by a field of type <code>SparseMatrixCSC{ComplexF64, Int64}</code> (i.e., the 8x8 matrix containing the Pauli matrix, tensored with the identity matrices of the other two qubits). Then, we can also see that it is a <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.Operator"><code>Operator</code></a>, with <code>3</code> subsystems in total. Hence, just looking at the type of the object, the compiler has all the information it needs to generate a specialized version of the functions.</p><p>Let&#39;s see more in the details all the internal fields of the <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a> type:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fieldnames</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(obj_type)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">(:data, :type, :dimensions)</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">σx_2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">8×8 SparseArrays.SparseMatrixCSC{ComplexF64, Int64} with 8 stored entries:</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅      1.0+0.0im  …      ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 1.0+0.0im      ⋅          ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅      1.0+0.0im      ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅             ⋅      1.0+0.0im      ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅      …      ⋅          ⋅      1.0+0.0im</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅             ⋅          ⋅          ⋅    </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">     ⋅          ⋅          ⋅         1.0+0.0im      ⋅          ⋅</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">σx_2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">type</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Operator()</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">σx_2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dims</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">([2, 2, 2], [2, 2, 2])</span></span></code></pre></div><p>The <code>dims</code> field contains the dimensions of the subsystems (in this case, three subsystems with dimension <code>2</code> each). We can see that the type of <code>dims</code> is <code>SVector</code> instead of <code>Vector</code>. As we mentioned before, this is very useful in functions like <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.ptrace"><code>ptrace</code></a>. Let&#39;s do a simple example of reshaping an operator internally generated from some <code>dims</code> input:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dims)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Qobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">randn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">get_hilbert_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dims)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Operator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), dims</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dims)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op_dims </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dims</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(op_data, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vcat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(op_dims</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Array{Float64, 6}</span></span></code></pre></div><p>Which returns a tensor of size <code>2x2x2x2x2x2</code>. Let&#39;s check the <code>@code_warntype</code>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Main.var&quot;Main&quot;.reshape_operator_data(::Vector{Int64})</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from reshape_operator_data(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">dims</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:185</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #self#</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.reshape_operator_data)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  dims</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Vector{Int64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Locals</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  op_data</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Matrix{Float64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  op_dims</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Tuple{Any, Any}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  op</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::QuantumObject{Operator, ProductDimensions{M, N, T1, T2}, Matrix{Float64}} where {M, N, T1&lt;:Tuple, T2&lt;:Tuple}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %1  = Main.var&quot;Main&quot;.randn</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(randn)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %2  = Main.var&quot;Main&quot;.get_hilbert_size</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(QuantumToolbox.get_hilbert_size)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %3  = (%2)(dims)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %4  = Core._apply_iterate(Base.iterate, %1, %3)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Matrix{Float64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %5  = Main.var&quot;Main&quot;.Operator</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Operator)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %6  = (%5)()</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Operator())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %7  = (:type, :dims)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((:type, :dims))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %8  = Core.apply_type(Core.NamedTuple, %7)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(NamedTuple{(:type, :dims)})</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %9  = Core.tuple(%6, dims)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Operator, Vector{Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %10 = (%8)(%9)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::@NamedTuple{type::Operator, dims::Vector{Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %11 = Main.var&quot;Main&quot;.Qobj</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(QuantumObject)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (op = Core.kwcall(%10, %11, %4))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %13 = op</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::QuantumObject{Operator, ProductDimensions{M, N, T1, T2}, Matrix{Float64}} where {M, N, T1&lt;:Tuple, T2&lt;:Tuple}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (op_dims = Base.getproperty(%13, :dims))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %15 = op</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::QuantumObject{Operator, ProductDimensions{M, N, T1, T2}, Matrix{Float64}} where {M, N, T1&lt;:Tuple, T2&lt;:Tuple}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (op_data = Base.getproperty(%15, :data))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %17 = Main.var&quot;Main&quot;.reshape</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(reshape)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %18 = op_data</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Matrix{Float64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %19 = Core.tuple(%18)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Matrix{Float64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %20 = Main.var&quot;Main&quot;.vcat</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(vcat)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %21 = op_dims</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Tuple{Any, Any}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %22 = Core._apply_iterate(Base.iterate, %20, %21)</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %23 = Core._apply_iterate(Base.iterate, %17, %19, %22)</span><span style="--shiki-light:#cb2431;--shiki-light-font-weight:bold;--shiki-dark:#f97583;--shiki-dark-font-weight:bold;">::Any</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       return %23</span></span></code></pre></div><p>We got a <code>Any</code> type, because the compiler doesn&#39;t know the size of the <code>dims</code> vector. We can fix this by using a <code>Tuple</code> (or <code>SVector</code> from <a href="https://github.com/JuliaArrays/StaticArrays.jl" target="_blank" rel="noreferrer">StaticArrays.jl</a>):</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Array{Float64, 6}</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Main.var&quot;Main&quot;.reshape_operator_data(::Tuple{Int64, Int64, Int64})</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from reshape_operator_data(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">dims</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:185</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #self#</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.reshape_operator_data)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  dims</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Int64, Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Locals</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  op_data</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Matrix{Float64}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  op_dims</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{StaticArraysCore.SVector{3, Int64}, StaticArraysCore.SVector{3, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  op</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::QuantumObject{Operator, ProductDimensions{3, 3, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}}, Matrix{Float64}}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Array{Float64, 6}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %1  = Main.var&quot;Main&quot;.randn</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(randn)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %2  = Main.var&quot;Main&quot;.get_hilbert_size</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(QuantumToolbox.get_hilbert_size)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %3  = (%2)(dims)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Int64, Int64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %4  = Core._apply_iterate(Base.iterate, %1, %3)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Matrix{Float64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %5  = Main.var&quot;Main&quot;.Operator</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Operator)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %6  = (%5)()</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Operator())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %7  = (:type, :dims)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((:type, :dims))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %8  = Core.apply_type(Core.NamedTuple, %7)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(NamedTuple{(:type, :dims)})</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %9  = Core.tuple(%6, dims)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Operator, Tuple{Int64, Int64, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %10 = (%8)(%9)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::@NamedTuple{type::Operator, dims::Tuple{Int64, Int64, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %11 = Main.var&quot;Main&quot;.Qobj</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(QuantumObject)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (op = Core.kwcall(%10, %11, %4))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %13 = op</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::QuantumObject{Operator, ProductDimensions{3, 3, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}}, Matrix{Float64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (op_dims = Base.getproperty(%13, :dims))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %15 = op</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::QuantumObject{Operator, ProductDimensions{3, 3, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}, Tuple{HilbertSpace, HilbertSpace, HilbertSpace}}, Matrix{Float64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (op_data = Base.getproperty(%15, :data))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %17 = Main.var&quot;Main&quot;.reshape</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(reshape)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %18 = op_data</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Matrix{Float64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %19 = Core.tuple(%18)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{Matrix{Float64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %20 = Main.var&quot;Main&quot;.vcat</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(vcat)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %21 = op_dims</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Tuple{StaticArraysCore.SVector{3, Int64}, StaticArraysCore.SVector{3, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %22 = Core._apply_iterate(Base.iterate, %20, %21)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::StaticArraysCore.SVector{6, Int64}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %23 = Core._apply_iterate(Base.iterate, %17, %19, %22)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Array{Float64, 6}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       return %23</span></span></code></pre></div><p>Finally, let&#39;s look at the benchmarks</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">BenchmarkTools.Trial: 10000 samples with 9 evaluations per sample.</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Range </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">min</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;">max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">2.762 μs</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;">  8.489 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">min … max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">): </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00% … 0.00%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):     </span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">3.343 μs               </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):    </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">mean</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):   </span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">3.422 μs</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">370.551 ns</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">mean ± σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">0.00% ± 0.00%</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">           ▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">    ▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">    ▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">                                     </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  ▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▆</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▇</span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ▃</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  2.76 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">         Histogram: frequency by time</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">        4.78 μs </span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">&lt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Memory estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">1.86 KiB</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, allocs estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">41</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">.</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@benchmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reshape_operator_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">BenchmarkTools.Trial: 10000 samples with 496 evaluations per sample.</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Range </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">min</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;">max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#1b7c83;--shiki-light-font-weight:bold;--shiki-dark:#39c5cf;--shiki-dark-font-weight:bold;">219.460 ns</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> … </span><span style="--shiki-light:#5a32a3;--shiki-dark:#b392f0;">173.679 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">min … max</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">): </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 0.00% … 99.71%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):     </span><span style="--shiki-light:#0366d6;--shiki-light-font-weight:bold;--shiki-dark:#2188ff;--shiki-dark-font-weight:bold;">234.067 ns               </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">median</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):    </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 0.00%</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Time  </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">mean</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):   </span><span style="--shiki-light:#28a745;--shiki-light-font-weight:bold;--shiki-dark:#34d058;--shiki-dark-font-weight:bold;">408.887 ns</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ± </span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">  2.472 μs</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">  ┊</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> GC </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">(</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">mean ± σ</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">):  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">19.24% ±  7.57%</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">   █</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">                                                             </span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  ▇</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">█</span><span style="--shiki-light:#0366d6;--shiki-dark:#2188ff;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#28a745;--shiki-dark:#34d058;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▅</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▃</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▁</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">▂</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> ▂</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  219 ns</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">           Histogram: frequency by time</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">          596 ns </span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">&lt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> Memory estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">672 bytes</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, allocs estimate</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">: </span><span style="--shiki-light:#dbab09;--shiki-dark:#ffea7f;">3</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">.</span></span></code></pre></div><p>Which is an innocuous but huge difference in terms of performance. Hence, we highly recommend using <code>Tuple</code> or <code>SVector</code> from <a href="https://github.com/JuliaArrays/StaticArrays.jl" target="_blank" rel="noreferrer">StaticArrays.jl</a> when defining the dimensions of a user-defined <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a>.</p><h2 id="The-use-of-Val-in-some-QuantumToolbox.jl-functions" tabindex="-1">The use of <code>Val</code> in some <code>QuantumToolbox.jl</code> functions <a class="header-anchor" href="#The-use-of-Val-in-some-QuantumToolbox.jl-functions" aria-label="Permalink to &quot;The use of \`Val\` in some \`QuantumToolbox.jl\` functions {#The-use-of-Val-in-some-QuantumToolbox.jl-functions}&quot;">​</a></h2>`,33)),i("p",null,[s[6]||(s[6]=a("In some functions of ",-1)),s[7]||(s[7]=i("code",null,"QuantumToolbox.jl",-1)),s[8]||(s[8]=a(", you may find the use of the ",-1)),s[9]||(s[9]=i("a",{href:"https://docs.julialang.org/en/v1/base/base/#Base.Val",target:"_blank",rel:"noreferrer"},[i("code",null,"Val")],-1)),s[10]||(s[10]=a(" type in the arguments. This is a trick to pass a value at compile time, and it is very useful to avoid type instabilities. Let's make a very simple example, where we want to create a Fock state ",-1)),i("mjx-container",d,[(n(),t("svg",r,[...s[5]||(s[5]=[e('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math" data-latex="|j\\rangle"><g data-mml-node="mo" data-latex="|"><path data-c="7C" d="M139-250C152-250 159-242 159-226L159 726C159 742 152 750 139 750C126 750 119 742 119 726L119-226C119-242 126-250 139-250Z"></path></g><g data-mml-node="mi" data-latex="j" transform="translate(278,0)"><path data-c="1D457" d="M397 621C397 648 383 661 356 661C328 661 300 633 300 605C300 578 313 565 340 565C368 565 397 593 397 621M267 444C214 444 169 404 147 369C120 326 107 299 107 287C107 278 112 274 122 274C127 274 130 275 133 276C138 284 141 291 144 296C176 375 216 414 264 414C282 414 291 400 291 373C291 358 289 341 284 323L192-46C178-104 138-175 75-175C66-175 57-174 48-171C73-161 85-143 85-118C85-92 71-79 44-79C12-79-13-108-13-140C-13-184 30-205 77-205C120-205 160-190 197-160C232-131 254-94 265-51L356 311C359 324 361 337 361 349C361 404 322 444 267 444Z"></path></g><g data-mml-node="mo" data-latex="\\rangle" transform="translate(690,0)"><path data-c="27E9" d="M278 242C279 244 279 247 279 250C279 253 279 256 278 258L98 735C94 745 87 750 76 750C61 750 53 742 53 726C53 723 53 720 54 718L231 250L54-217C53-219 53-222 53-226C53-242 61-250 76-250C87-250 94-245 98-235Z"></path></g></g></g>',1)])]))]),s[11]||(s[11]=a(" of a given dimension ",-1)),s[12]||(s[12]=i("code",null,"N",-1)),s[13]||(s[13]=a(", and we give the possibility to create it as a sparse or dense vector. At first, we can write the function without using ",-1)),s[14]||(s[14]=i("code",null,"Val",-1)),s[15]||(s[15]=a(":",-1))]),s[18]||(s[18]=e(`<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SparseArrays</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sparse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sparsevec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], N)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ComplexF64, N)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array[j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> QuantumObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(array; type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Ket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">my_fock(2, 1) =</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Quantum Object:   type=Ket()   dims=([2], [1])   size=(2,)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">2-element Vector{ComplexF64}:</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 0.0 + 0.0im</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 1.0 + 0.0im</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">my_fock(2, 1; sparse = true) =</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Quantum Object:   type=Ket()   dims=([2], [1])   size=(2,)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">2-element SparseArrays.SparseVector{ComplexF64, Int64} with 1 stored entry:</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  [2]  =  1.0+0.0im</span></span></code></pre></div><p>But it is immediately clear that the return type of this function is not clear, because it depends on the value of the <code>sparse</code> argument. We can check it using the <code>@code_warntype</code> macro:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Main.var&quot;Main&quot;.my_fock(::Int64, ::Int64)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from my_fock(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">N</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">j</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">; sparse)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:230</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #self#</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.my_fock)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  N</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  j</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Vector{ComplexF64}}, QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, SparseArrays.SparseVector{ComplexF64, Int64}}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %1 = Main.var&quot;Main&quot;.:(var&quot;#my_fock#1&quot;)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock#1&quot;)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %2 = (%1)(false, #self#, N, j)</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Vector{ComplexF64}}, QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, SparseArrays.SparseVector{ComplexF64, Int64}}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">      return %2</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Core.kwcall(::@NamedTuple{sparse::Bool}, ::typeof(Main.var&quot;Main&quot;.my_fock), ::Int64, ::Int64)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from kwcall(::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">NamedTuple</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, ::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">typeof(Main.var&quot;Main&quot;.my_fock)</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">N</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">j</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:230</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #s5</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Core.kwcall)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_2</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::@NamedTuple{sparse::Bool}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_3</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.my_fock)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  N</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  j</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Locals</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  sparse</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Union{}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_7</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Bool</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Vector{ComplexF64}}, QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, SparseArrays.SparseVector{ComplexF64, Int64}}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.NewvarNode(:(sparse))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.NewvarNode(:(@_7))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %3  = Core.isdefined(@_2, :sparse)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #6 if not %3</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">2 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %5  = Core.getfield(@_2, :sparse)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Bool</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %6  = Main.var&quot;Main&quot;.Bool</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Bool)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %7  = (%5 isa %6)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #4 if not %7</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">3 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #5</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">4 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(Main.var&quot;Main&quot;.Bool))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(%new(Core.TypeError, Symbol(&quot;keyword argument&quot;), :sparse, %10, %5)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(Core.throw(%11)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">5 ┄─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (@_7 = %5)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #7</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">6 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(@_7 = false))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">7 ┄─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %16 = @_7</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Bool</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %17 = Base.keys(@_2)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((:sparse,))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %18 = (:sparse,)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((:sparse,))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %19 = Base.diff_names(%17, %18)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %20 = Base.isempty(%19)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #9 if not %20</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">8 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #10</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">9 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(Base.kwerr(@_2, @_3, N, j)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">10 ┄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %24 = Main.var&quot;Main&quot;.:(var&quot;#my_fock#1&quot;)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock#1&quot;)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %25 = (%24)(%16, @_3, N, j)</span><span style="--shiki-light:#dbab09;--shiki-light-font-weight:bold;--shiki-dark:#ffea7f;--shiki-dark-font-weight:bold;">::Union{QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Vector{ComplexF64}}, QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, SparseArrays.SparseVector{ComplexF64, Int64}}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       return %25</span></span></code></pre></div><p>We can fix this by using the <code>Val</code> type, where we enable the multiple dispatch of the function:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getVal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Val{N}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Val</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> getVal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sparse)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ComplexF64, N)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array[j</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        array </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sparsevec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0im</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], N)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> QuantumObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(array; type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Ket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@show</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">my_fock_good(2, 1) =</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Quantum Object:   type=Ket()   dims=([2], [1])   size=(2,)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">2-element SparseArrays.SparseVector{ComplexF64, Int64} with 1 stored entry:</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  [2]  =  1.0+0.0im</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">my_fock_good(2, 1; sparse = Val(true)) =</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Quantum Object:   type=Ket()   dims=([2], [1])   size=(2,)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">2-element Vector{ComplexF64}:</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 0.0 + 0.0im</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> 1.0 + 0.0im</span></span></code></pre></div><p>And now the return type of the function is clear:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Main.var&quot;Main&quot;.my_fock_good(::Int64, ::Int64)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from my_fock_good(</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">N</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">j</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">; sparse)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:258</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #self#</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.my_fock_good)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  N</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  j</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, SparseArrays.SparseVector{ComplexF64, Int64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %1 = Main.var&quot;Main&quot;.:(var&quot;#my_fock_good#2&quot;)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock_good#2&quot;)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %2 = Main.var&quot;Main&quot;.Val(false)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Val{false}())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│  </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %3 = (%1)(%2, #self#, N, j)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.PartialStruct(QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, SparseArrays.SparseVector{ComplexF64, Int64}}, Any[SparseArrays.SparseVector{ComplexF64, Int64}, Core.Const(Ket()), Core.PartialStruct(ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Any[Tuple{HilbertSpace}, Core.Const((HilbertSpace(1),))])])</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">      return %3</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@code_warntype</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> my_fock_good</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; sparse </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">MethodInstance for Core.kwcall(::@NamedTuple{sparse::Val{true}}, ::typeof(Main.var&quot;Main&quot;.my_fock_good), ::Int64, ::Int64)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  from kwcall(::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">NamedTuple</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, ::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">typeof(Main.var&quot;Main&quot;.my_fock_good)</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">N</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">, </span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">j</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">::</span><span style="--shiki-light:#24292e;--shiki-light-font-weight:bold;--shiki-dark:#e1e4e8;--shiki-dark-font-weight:bold;">Int64</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">)</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> @</span><span style="--shiki-light:#959da5;--shiki-dark:#959da5;"> Main.var&quot;Main&quot;</span><span style="--shiki-light:#959da5;--shiki-light-text-decoration:underline;--shiki-dark:#959da5;--shiki-dark-text-decoration:underline;"> type_stability.md:258</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Arguments</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  #s5</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Core.kwcall)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_2</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((sparse = Val{true}(),))</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_3</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.my_fock_good)</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  N</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  j</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Int64</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Locals</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  sparse</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Union{}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">  @_7</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Val{true}</span></span>
<span class="line"><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">Body</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Vector{ComplexF64}}</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">1 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.NewvarNode(:(sparse))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.NewvarNode(:(@_7))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %3  = Core.isdefined(@_2, :sparse)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #6 if not %3</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">2 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %5  = Core.getfield(@_2, :sparse)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Val{true}())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %6  = (%5 isa Main.var&quot;Main&quot;.Val)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #4 if not %6</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">3 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #5</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">4 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(%new(Core.TypeError, Symbol(&quot;keyword argument&quot;), :sparse, Main.var&quot;Main&quot;.Val, %5)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(Core.throw(%9)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">5 ┄─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       (@_7 = %5)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #7</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">6 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(@_7 = Main.var&quot;Main&quot;.Val(false)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">7 ┄─</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %14 = @_7</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Val{true}())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %15 = Base.keys(@_2)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((:sparse,))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %16 = (:sparse,)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const((:sparse,))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %17 = Base.diff_names(%15, %16)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(())</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %18 = Base.isempty(%17)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(true)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #9 if not %18</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">8 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       goto #10</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">9 ──</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       Core.Const(:(Base.kwerr(@_2, @_3, N, j)))</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">10 ┄</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %22 = Main.var&quot;Main&quot;.:(var&quot;#my_fock_good#2&quot;)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.Const(Main.var&quot;Main&quot;.var&quot;#my_fock_good#2&quot;)</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">│   </span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;"> %23 = (%22)(%14, @_3, N, j)</span><span style="--shiki-light:#1b7c83;--shiki-dark:#39c5cf;">::Core.PartialStruct(QuantumObject{Ket, ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Vector{ComplexF64}}, Any[Vector{ComplexF64}, Core.Const(Ket()), Core.PartialStruct(ProductDimensions{1, 1, Tuple{HilbertSpace}, Tuple{HilbertSpace}}, Any[Tuple{HilbertSpace}, Core.Const((HilbertSpace(1),))])])</span></span>
<span class="line"><span style="--shiki-light:#959da5;--shiki-dark:#959da5;">└───</span><span style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;">       return %23</span></span></code></pre></div><p>This is exactly how the current <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.fock"><code>fock</code></a> function is implemented in <code>QuantumToolbox.jl</code>. There are many other functions that support this feature, and we highly recommend using it when necessary.</p><h2 id="Conclusions" tabindex="-1">Conclusions <a class="header-anchor" href="#Conclusions" aria-label="Permalink to &quot;Conclusions {#Conclusions}&quot;">​</a></h2><p>In this page, we have seen the importance of type stability in Julia, and how to write efficient code in the context of <code>QuantumToolbox.jl</code>. We have seen that the internal structure of the <a href="/QuantumToolbox.jl/previews/PR667/resources/api#QuantumToolbox.QuantumObject"><code>QuantumObject</code></a> type is already optimized for the compiler, and we have seen some practical examples of how to write efficient code. We have seen that the use of <code>Vector</code> should be avoided when the elements don&#39;t have the same type, and that the use of <code>Tuple</code> or <code>SVector</code> is highly recommended when the size of the array is known at compile time. Finally, we have seen the use of <code>Val</code> to pass values at compile time, to avoid type instabilities in some functions. \`\`\`</p>`,18))])}const m=h(l,[["render",o]]);export{E as __pageData,m as default};
